# Схема сетевого взаимодействия системы DICSS

## Содержание

1. [Методология использования схемы](#методология-использования-схемы)
2. [Схема угроз безопасности](#1-схема-угроз-безопасности)
3. [Схема информационных потоков и логическое построение сети](#2-схема-информационных-потоков-и-логическое-построение-сети)
4. [Таблица анализа угроз](#3-таблица-анализа-угроз)
5. [Детализация компонентов](#4-детализация-компонентов)
6. [Правила Firewall на роутере](#5-правила-firewall-на-роутере)
7. [Фильтрация по MAC-адресам](#6-фильтрация-по-mac-адресам)
8. [Потоки данных](#7-потоки-данных)
9. [Механизмы безопасности](#8-механизмы-безопасности)
10. [Матрица портов и протоколов](#9-матрица-портов-и-протоколов)

---

## Методология использования схемы

### Как использовать схему для анализа угроз:

1. **Берем угрозу** из модели угроз (THREAT_MODEL.md, Модель угроз.txt)
2. **Анализируем протоколы и инфраструктуру**:
   - Какой протокол нужно задействовать или обойти? (MQTT, HTTPS, DHCP, MAC filtering, Firewall)
   - Какая инфраструктура задействована? (роутер, Wi-Fi контроллер, контроллер умного дома, устройства)
   - Где в схеме находится точка реализации угрозы?
3. **Оцениваем возможность реализации**:
   - Можно ли обойти защитные механизмы?
   - Какие барьеры существуют?
   - Требуется ли компрометация нескольких компонентов?
4. **Определяем последствия**:
   - Что произойдет при успешной реализации?
   - Какие данные/функции будут скомпрометированы?
   - Критичность последствий

### Структура таблицы анализа угроз

Таблица содержит следующие колонки:

- **Угроза**: Название и описание угрозы из модели угроз
- **Способ реализации**: Детальное описание как злоумышленник может реализовать угрозу
- **Протоколы/Инфраструктура**: Какие протоколы (MQTT, HTTPS, DHCP, MAC, Firewall) и компоненты (роутер, Wi-Fi, контроллер, устройства) нужно задействовать или обойти
- **Возможность реализации**: Оценка возможности реализации угрозы с учетом существующих защитных механизмов:
  - **Высокая**: Защита отсутствует или слабая, угроза легко реализуема
  - **Средняя**: Защита частичная, требуется определенный уровень навыков
  - **Низкая**: Защита сильная, требуется высокая квалификация и/или компрометация нескольких компонентов
  - **Невозможна**: Защита полностью блокирует угрозу при правильной конфигурации
- **Мероприятия по защите**: Существующие меры защиты и рекомендации по улучшению
- **Последствия**: Описание что произойдет при успешной реализации угрозы (конфиденциальность, целостность, доступность)

---

## 1. Схема угроз безопасности

### 1.1 Физическая топология с отметками угроз

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ВНЕШНЯЯ СЕТЬ (Internet)                            │
│                                                                               │
│  [Угроза: DDoS, фишинг, взлом из интернета]                                  │
│                                                                               │
│  ┌──────────────────┐                                                        │
│  │   Смартфон       │  (может быть внутри сети или снаружи)                  │
│  │   [Угроза:       │  [Угроза: компрометация при доступе из интернета]       │
│  │   вирус на ПК]   │                                                        │
│  └────────┬─────────┘                                                        │
└───────────┼───────────────────────────────────────────────────────────────────┘
            │
            │ Оптическое волокно
            │
┌───────────▼───────────────────────────────────────────────────────────────────┐
│              ОПТИЧЕСКИЙ КОММУТАТОР                                             │
│  [Угроза: перехват трафика, физическое вмешательство]                         │
│  [Угроза: нарушение работы канала связи]                                       │
└───────────┬───────────────────────────────────────────────────────────────────┘
            │
            │ Ethernet
            │
┌───────────▼───────────────────────────────────────────────────────────────────┐
│                    РОУТЕР (белый IP для P2P)                                  │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Функции:                                                             │   │
│  │  • NAT (Network Address Translation)                                  │   │
│  │  • Firewall (Stateful Packet Inspection)                             │   │
│  │  • MAC Address Filtering (Whitelist для IoT)                          │   │
│  │  • DHCP Server                                                        │   │
│  │  • P2P связь (белый IP)                                               │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  [Угроза: взлом роутера, компрометация firewall]                             │
│  [Угроза: MAC spoofing, обход MAC filtering]                                 │
│  [Угроза: несанкционированное проникновение через роутер]                    │
└───────────┬───────────────────────────────────────────────────────────────────┘
            │
            │ Ethernet / Wi-Fi
            │
┌───────────▼───────────────────────────────────────────────────────────────────┐
│                    WI-FI КОНТРОЛЛЕР                                           │
│  • Управление Wi-Fi сетью                                                     │
│  • WPA3 шифрование                                                            │
│  • WPS отключен                                                               │
│                                                                               │
│  [Угроза: взлом Wi-Fi, перехват радиосигнала]                                │
│  [Угроза: глушение беспроводных каналов связи]                                │
└───────────┬───────────────────────────────────────────────────────────────────┘
            │
            │ Радиосигнал Wi-Fi
            │
┌───────────▼───────────────────────────────────────────────────────────────────┐
│                    АНТЕННЫ WI-FI                                              │
│  • Точки доступа                                                              │
│                                                                               │
│  [Угроза: глушение сигнала, перехват]                                         │
└───────────┬───────────────────────────────────────────────────────────────────┘
            │
            │ Звездообразная топология (Star Topology)
            │
    ┌───────┼───────┬───────────────┬───────────────┐
    │       │       │               │               │
┌───▼───┐ ┌─▼───┐ ┌─▼────┐ ┌───────▼──────┐ ┌─────▼──────┐
│Смарт- │ │Умные│ │Умные │ │  Контроллер   │ │Пользователь│
│фон    │ │устр.│ │устр. │ │  умного дома  │ │ский ПК     │
│       │ │     │ │      │ │               │ │            │
│       │ │     │ │      │ │ • MQTT Broker │ │            │
│       │ │     │ │      │ │ • PostgreSQL  │ │            │
│       │ │     │ │      │ │ • Payara 6    │ │            │
│       │ │     │ │      │ │               │ │            │
│       │ │     │ │      │ │ :8884 (mTLS)  │ │            │
│       │ │     │ │      │ │ :5432         │ │            │
│       │ │     │ │      │ │ :9080, :9048  │ │            │
└───────┘ └─────┘ └──────┘ └───────┬───────┘ └─────┬──────┘
    │       │       │               │               │
    │       │       │               │               │
    │[Угроза:│[Угроза:│[Угроза:      │[Угроза:       │[Угроза:
    │компро- │взлом  │физическая    │компрометация  │вирус на
    │метация│firmware│манипуляция   │MQTT брокера,  │ПК,
    │при    │        │              │БД, API        │несанкцио-
    │доступе│        │              │               │нированное
    │из     │        │              │               │проникно-
    │интер- │        │              │               │вение
    │нета]  │        │              │               │
    │       │        │              │               │
    └───────┴────────┴──────────────┴───────────────┘
                    [Угроза: нарушение электропитания]
                    [Угроза: нарушение работы внутреннего канала связи]
```

### 1.2 Таблица угроз по компонентам

| Компонент | Угрозы | Векторы атак |
|-----------|--------|--------------|
| **Оптический коммутатор** | Перехват трафика, физическое вмешательство, нарушение канала связи | Физический доступ, перехват оптического сигнала, повреждение кабеля |
| **Роутер** | Взлом, компрометация firewall, MAC spoofing, несанкционированное проникновение | Эксплуатация уязвимостей, подбор паролей, обход MAC filtering, компрометация DHCP |
| **Wi-Fi контроллер** | Взлом Wi-Fi, перехват радиосигнала, глушение каналов | Взлом WPA3, перехват пакетов, jamming атаки |
| **Антенны Wi-Fi** | Глушение сигнала, перехват | Радиопомехи, пассивный перехват |
| **Контроллер умного дома** | Компрометация MQTT брокера, БД, API, DoS | Эксплуатация уязвимостей, SQL injection, несанкционированный доступ к API |
| **Умные устройства** | Взлом firmware, физическая манипуляция, клонирование | Эксплуатация уязвимостей, физический доступ, экстракция ключей |
| **Смартфон** | Компрометация при доступе из интернета, вирус | Фишинг, вредоносное ПО, компрометация приложения |
| **Пользовательский ПК** | Вирус, несанкционированное проникновение | Вредоносное ПО, социальная инженерия, эксплуатация уязвимостей |
| **Электропитание** | Отключение питания, нарушение работы канала связи | Физическое отключение, программное управление выключателями |

### 1.3 Внутренние угрозы

**Вирус на пользовательском ПК:**
- Компрометация через вредоносное ПО
- Доступ к локальной сети через зараженный ПК
- Распространение на другие устройства в сети
- Перехват трафика с зараженного ПК

**Несанкционированное проникновение:**
- Через компрометированный ПК
- Через уязвимости в роутере
- Через взлом Wi-Fi
- Через физический доступ к устройствам

### 1.4 Угрозы электропитания

**Отключение электропитания:**
- Физическое отключение питания контроллера
- Программное управление автоматическими выключателями через MQTT
- Нарушение работы внутреннего канала связи при отключении питания

**Нарушение работы канала связи:**
- Отключение питания роутера
- Отключение питания Wi-Fi контроллера
- Отключение питания умных устройств
- Каскадные отказы при отключении питания

---

## 2. Схема информационных потоков и логическое построение сети

### 2.1 Логическая топология (OSI модель)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    УРОВЕНЬ ПРИЛОЖЕНИЙ (L7)                                   │
│  • MQTT (mTLS) - устройства ↔ контроллер                                     │
│  • HTTPS - смартфон ↔ контроллер (из интернета)                              │
│  • HTTP - пользовательский ПК ↔ контроллер (локально)                       │
└─────────────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ТРАНСПОРТНЫЙ УРОВЕНЬ (L4)                                 │
│  • TCP/TLS - MQTT (порт 8884), HTTPS (443), HTTP (9080)                     │
│  • UDP - DHCP (67/68)                                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                    СЕТЕВОЙ УРОВЕНЬ (L3)                                      │
│  • IP адресация (DHCP)                                                       │
│  • Firewall правила на роутере                                              │
│  • NAT (Network Address Translation)                                         │
└─────────────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                    КАНАЛЬНЫЙ УРОВЕНЬ (L2)                                    │
│  • MAC адресация                                                             │
│  • MAC filtering на роутере (Whitelist)                                      │
│  • Wi-Fi (802.11ax, WPA3)                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ФИЗИЧЕСКИЙ УРОВЕНЬ (L1)                                   │
│  • Оптическое волокно                                                        │
│  • Ethernet кабель                                                           │
│  • Радиосигнал Wi-Fi (2.4/5 GHz)                                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 DHCP потоки

```
┌─────────────┐
│  Устройство │
│  (новое)    │
└──────┬──────┘
       │
       │ 1. DHCP Discover (broadcast)
       │    MAC: AA:BB:CC:DD:EE:FF
       │
┌──────▼─────────────────────────────────────┐
│ Роутер (DHCP Server)                        │
│ • Проверка MAC в whitelist                  │
│ • Если MAC разрешен → выдача IP             │
│ • Если MAC не разрешен → блокировка         │
└──────┬─────────────────────────────────────┘
       │
       │ 2. DHCP Offer
       │    IP: 192.168.1.100
       │    Gateway: 192.168.1.1
       │    DNS: 192.168.1.1
       │
┌──────▼──────┐
│  Устройство │
│  Получило IP│
└─────────────┘
```

### 2.3 MAC filtering процесс

```
┌─────────────┐
│  Устройство │
│  MAC: XX:XX │
└──────┬──────┘
       │
       │ Попытка подключения
       │
┌──────▼─────────────────────────────────────┐
│ Роутер                                      │
│ ┌───────────────────────────────────────┐ │
│ │ MAC Whitelist:                        │ │
│ │ • AA:BB:CC:DD:EE:01 (TEMP_SENSOR)     │ │
│ │ • AA:BB:CC:DD:EE:02 (SMART_PLUG)      │ │
│ │ • AA:BB:CC:DD:EE:03 (ENERGY_SENSOR)   │ │
│ │ • ...                                 │ │
│ └───────────────────────────────────────┘ │
│                                            │
│ Проверка: MAC в whitelist?                 │
└──────┬─────────────────────────────────────┘
       │
       ├─→ ДА → Разрешить подключение → Выдать IP через DHCP
       │
       └─→ НЕТ → Блокировать → Логировать попытку
```

### 2.4 Firewall правила (логика на роутере)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    FIREWALL НА РОУТЕРЕ                                       │
│                                                                               │
│  ВХОДЯЩИЙ ТРАФИК (из Internet):                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Правило 1: Блокировать все входящие соединения по умолчанию          │   │
│  │ Правило 2: Разрешить только P2P трафик (белый IP)                   │   │
│  │ Правило 3: Блокировать MQTT (8884) из интернета                      │   │
│  │ Правило 4: Блокировать PostgreSQL (5432) из интернета               │   │
│  │ Правило 5: Блокировать Payara (9080, 9048) из интернета             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  ИСХОДЯЩИЙ ТРАФИК (в Internet):                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Правило 1: Разрешить HTTPS (443) для обновлений                      │   │
│  │ Правило 2: Разрешить DNS (53)                                        │   │
│  │ Правило 3: Разрешить NTP (123)                                        │   │
│  │ Правило 4: Блокировать все остальное по умолчанию                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  ВНУТРЕННИЙ ТРАФИК (LAN):                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Правило 1: Разрешить MQTT (8884) устройства → контроллер             │   │
│  │ Правило 2: Разрешить HTTP (9080) ПК → контроллер                     │   │
│  │ Правило 3: Блокировать прямой доступ к PostgreSQL (5432)            │   │
│  │ Правило 4: Блокировать межсетевое взаимодействие устройств           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.5 HTTPS потоки

**Сценарий 1: Смартфон внутри сети**
```
┌─────────────┐
│  Смартфон   │
│  (внутри)   │
└──────┬──────┘
       │
       │ 1. Wi-Fi подключение (WPA3)
       │
┌──────▼─────────────────────────────────────┐
│ Wi-Fi контроллер                            │
│ • Аутентификация WPA3                      │
└──────┬─────────────────────────────────────┘
       │
       │ 2. Получение IP через DHCP
       │
┌──────▼─────────────────────────────────────┐
│ Роутер                                      │
│ • MAC filtering                            │
│ • DHCP выдача IP                           │
└──────┬─────────────────────────────────────┘
       │
       │ 3. HTTPS запрос (локально)
       │    https://192.168.1.50:9080/api/...
       │
┌──────▼─────────────────────────────────────┐
│ Контроллер умного дома                     │
│ • Payara 6 (порт 9080)                     │
│ • REST API                                 │
└────────────────────────────────────────────┘
```

**Сценарий 2: Смартфон снаружи (из интернета)**
```
┌─────────────┐
│  Смартфон   │
│  (интернет) │
└──────┬──────┘
       │
       │ 1. HTTPS запрос через интернет
       │    https://<белый_IP>:9080/api/...
       │
┌──────▼─────────────────────────────────────┐
│ Роутер (белый IP)                          │
│ • Firewall: проверка правил                │
│ • NAT: перенаправление на контроллер       │
└──────┬─────────────────────────────────────┘
       │
       │ 2. HTTPS запрос (внутренний)
       │    https://192.168.1.50:9080/api/...
       │
┌──────▼─────────────────────────────────────┐
│ Контроллер умного дома                     │
│ • Payara 6 (порт 9080)                     │
│ • REST API                                 │
└────────────────────────────────────────────┘
```

### 2.6 MQTT потоки (mTLS)

```
┌─────────────┐
│Умное        │
│устройство   │
└──────┬──────┘
       │
       │ 1. Wi-Fi подключение (WPA3)
       │    MAC: AA:BB:CC:DD:EE:01
       │
┌──────▼─────────────────────────────────────┐
│ Wi-Fi контроллер                            │
│ • Аутентификация WPA3                      │
└──────┬─────────────────────────────────────┘
       │
       │ 2. DHCP запрос
       │
┌──────▼─────────────────────────────────────┐
│ Роутер                                      │
│ • MAC filtering: проверка whitelist        │
│ • DHCP: выдача IP (192.168.1.101)          │
└──────┬─────────────────────────────────────┘
       │
       │ 3. MQTT Connect (mTLS)
       │    ssl://192.168.1.50:8884
       │    Client Certificate: device.p12
       │
┌──────▼─────────────────────────────────────┐
│ Контроллер умного дома                     │
│ • MQTT Broker (Moquette)                   │
│ • Порт 8884 (mTLS, ClientAuth.REQUIRE)     │
│ • Проверка клиентского сертификата          │
│ • Device Authenticator                     │
│ • Device AuthorizatorPolicy (ACL)          │
└──────┬─────────────────────────────────────┘
       │
       │ 4. MQTT сообщения (зашифрованы TLS)
       │    Topic: home/controller1/devices/IOT-2025-0001/telemetry
       │    Payload: {temperature: 22.5, humidity: 60}
       │
┌──────▼─────────────────────────────────────┐
│ Device Interceptor                          │
│ • Обработка сообщений                       │
│ • Валидация устройств                       │
└──────┬─────────────────────────────────────┘
       │
       │ 5. Сохранение в БД
       │
┌──────▼─────────────────────────────────────┐
│ PostgreSQL Database                         │
│ • Порт 5432                                 │
│ • Таблица telemetry                         │
└────────────────────────────────────────────┘
```

### 2.7 Матрица протоколов по компонентам

| Компонент | Протоколы | Порт/Назначение | Безопасность |
|-----------|-----------|-----------------|--------------|
| **Оптический коммутатор** | Оптический сигнал | L1 (физический) | Физическая защита |
| **Роутер** | DHCP, NAT, Firewall, MAC filtering | 67/68, - | Stateful firewall, MAC whitelist |
| **Wi-Fi контроллер** | Wi-Fi (802.11ax), WPA3 | 2.4/5 GHz | WPA3, WPS отключен |
| **Антенны Wi-Fi** | Wi-Fi (802.11ax) | 2.4/5 GHz | WPA3 шифрование |
| **Контроллер умного дома** | MQTT (mTLS), PostgreSQL, HTTP/HTTPS | 8884, 5432, 9080, 9048 | mTLS, ClientAuth.REQUIRE, ACL |
| **Умные устройства** | MQTT (mTLS), Wi-Fi | 8884, Wi-Fi | mTLS клиент, WPA3 |
| **Смартфон** | HTTPS, Wi-Fi | 443, 9080, Wi-Fi | HTTPS, WPA3 |
| **Пользовательский ПК** | HTTP, Wi-Fi/Ethernet | 9080, Wi-Fi/Ethernet | HTTP (локально) |

---

## 3. Таблица анализа угроз

### 3.1 Угрозы несанкционированного доступа

| Угроза | Способ реализации | Протоколы/Инфраструктура | Возможность реализации | Мероприятия по защите | Последствия |
|--------|-------------------|-------------------------|------------------------|----------------------|-------------|
| **1. Несанкционированный удаленный доступ к контроллеру через Интернет** | Эксплуатация уязвимостей веб-интерфейса, подбор паролей, эксплуатация открытых портов | HTTPS/HTTP (9080), Роутер (firewall), Контроллер (Payara API) | **Высокая** (если порты открыты) | Firewall на роутере блокирует входящие соединения, закрытие портов из интернета | Полный контроль над системой, управление устройствами, доступ к БД |
| **2. Использование заводских учетных данных IoT-устройств** | Использование паролей по умолчанию, не измененных пользователем | Устройства (firmware), Wi-Fi | **Высокая** (если не изменены) | Смена всех паролей при настройке, использование уникальных паролей | Доступ к устройствам, компрометация локальной сети |
| **4. Несанкционированное подключение к Wi-Fi** | Взлом пароля Wi-Fi, использование уязвимостей WPA2/WPA3 | Wi-Fi контроллер, WPA3, Роутер (MAC filtering) | **Средняя** (WPA3 защищает, но возможен взлом) | WPA3 шифрование, сильные пароли, MAC filtering на роутере | Доступ к локальной сети, перехват трафика, атаки на устройства |
| **5. Физический доступ к контроллеру или устройствам** | Физическое подключение к оборудованию (USB, UART, JTAG) | Контроллер, Устройства (физический доступ) | **Средняя** (требуется физический доступ) | Физическая защита оборудования, опечатывание, контроль доступа | Извлечение данных, изменение настроек, компрометация ключей |
| **6. Несанкционированное подключение к MQTT-брокеру** | Подключение к открытому или слабо защищенному брокеру | MQTT (8884), mTLS, Контроллер (MQTT Broker) | **Невозможна** (mTLS с ClientAuth.REQUIRE блокирует) | mTLS с ClientAuth.REQUIRE, порт 1883 отключен, только порт 8884 | Перехват телеметрии, подмена команд, доступ к системе управления |
| **7. Использование заводских учетных данных MQTT-брокера** | Использование стандартных паролей (admin:admin) | MQTT, Контроллер | **Невозможна** (mTLS не использует пароли, только сертификаты) | mTLS с сертификатами, отсутствие паролей в MQTT | Доступ к MQTT брокеру, управление устройствами |

### 3.2 Угрозы перехвата и модификации данных

| Угроза | Способ реализации | Протоколы/Инфраструктура | Возможность реализации | Мероприятия по защите | Последствия |
|--------|-------------------|-------------------------|------------------------|----------------------|-------------|
| **8. Перехват трафика в Wi-Fi** | Прослушивание радиоканала для перехвата команд и телеметрии | Wi-Fi (802.11ax), WPA3, Антенны | **Низкая** (WPA3 защищает, но метаданные видны) | WPA3 шифрование, mTLS для MQTT (двойное шифрование) | Раскрытие телеметрии, анализ поведения, утечка расписания |
| **9. Атака Man-in-the-Middle (MITM)** | Перехват и модификация трафика между устройствами и контроллером | MQTT (mTLS), Wi-Fi, Роутер | **Низкая** (mTLS защищает, но возможна при компрометации CA) | mTLS с ClientAuth.REQUIRE, certificate pinning (рекомендуется) | Модификация команд, подмена телеметрии, полный контроль |
| **10. Подмена управляющих команд** | Отправка ложных команд на исполнительные устройства | MQTT, Контроллер (ACL), Устройства | **Низкая** (ACL блокирует публикацию в /cmd от устройств) | DeviceAuthorizatorPolicy (ACL) запрещает устройствам публиковать в /cmd | Несанкционированное управление электропитанием |
| **12. Перехват MQTT-сообщений при отсутствии TLS** | Прослушивание незашифрованного трафика (порт 1883) | MQTT (1883 plaintext), Контроллер | **Невозможна** (порт 1883 отключен) | Порт 1883 отключен, только порт 8884 (TLS) активен | Полный перехват всех MQTT сообщений, раскрытие данных |
| **13. Подмена управляющих команд через MQTT** | Публикация поддельных сообщений в топики управления | MQTT, Контроллер (ACL), DeviceAuthorizatorPolicy | **Низкая** (ACL блокирует) | DeviceAuthorizatorPolicy запрещает устройствам публиковать в /cmd топики | Несанкционированное управление устройствами |
| **14. Атака "subscribe to all" на MQTT-брокер** | Подписка на топик "#" для получения всей информации | MQTT, Контроллер (ACL), DeviceAuthorizatorPolicy | **Невозможна** (ACL блокирует wildcard для IoT) | DeviceAuthorizatorPolicy запрещает IoT устройствам подписываться на "#" | Получение всей информации о системе, перехват всех сообщений |
| **15. Перехват TLS-сертификата MQTT-брокера** | MITM атака при использовании самоподписанного сертификата | MQTT (mTLS), TLS, Контроллер | **Низкая** (mTLS защищает, но возможна при компрометации truststore) | mTLS с ClientAuth.REQUIRE, защита truststore, certificate pinning (рекомендуется) | Перехват и модификация всех MQTT сообщений |

### 3.3 Угрозы вредоносного программного воздействия

| Угроза | Способ реализации | Протоколы/Инфраструктура | Возможность реализации | Мероприятия по защите | Последствия |
|--------|-------------------|-------------------------|------------------------|----------------------|-------------|
| **16. Внедрение вредоносного кода в IoT-устройства** | Заражение через уязвимости ПО, использование в ботнетах | Устройства (firmware), Wi-Fi, MQTT | **Средняя** (требуется компрометация устройства) | Регулярные обновления firmware, secure boot (рекомендуется), мониторинг поведения | Использование устройств в ботнетах, атаки на другие системы |
| **18. Эксплуатация уязвимостей ПО** | Использование известных или 0-day уязвимостей | Контроллер (MQTT Broker, Payara, PostgreSQL), Устройства | **Средняя** (зависит от обновлений) | Регулярные обновления, мониторинг уязвимостей, применение патчей | Компрометация компонентов системы, получение контроля |
| **20. Компрометация MQTT-брокера** | Эксплуатация уязвимостей (SQL-инъекции, RCE, privilege escalation) | MQTT Broker (Moquette), Контроллер | **Низкая** (mTLS защищает подключения, но возможны уязвимости в коде) | Регулярные обновления Moquette, мониторинг логов, изоляция процесса | Полный контроль над системой, управление всеми устройствами |

### 3.4 Угрозы нарушения доступности

| Угроза | Способ реализации | Протоколы/Инфраструктура | Возможность реализации | Мероприятия по защите | Последствия |
|--------|-------------------|-------------------------|------------------------|----------------------|-------------|
| **21. DDoS-атака на контроллер** | Перегрузка большим количеством запросов | HTTP/HTTPS (9080), Роутер (firewall), Контроллер | **Средняя** (firewall частично защищает) | Firewall на роутере, rate limiting (рекомендуется), блокировка подозрительных IP | Недоступность системы управления, невозможность управления устройствами |
| **22. Глушение беспроводных каналов связи** | Радиопомехи в диапазонах Wi-Fi (2.4/5 ГГц) | Wi-Fi, Антенны, Радиосигнал | **Средняя** (требуется физическая близость) | Мониторинг качества сигнала, резервные каналы связи (рекомендуется) | Блокировка связи между устройствами и контроллером |
| **23. Отключение электропитания системы** | Физическое или программное отключение питания | Электропитание, Устройства, Контроллер | **Средняя** (требуется физический или программный доступ) | Резервное питание (ИБП), физическая защита выключателей, блокировка программного управления критичными выключателями | Полное обесточивание, недоступность системы |
| **25. DDoS-атака на MQTT-брокер** | Отправка большого количества MQTT-пакетов | MQTT (8884), mTLS, Контроллер, Роутер (firewall) | **Низкая** (mTLS требует сертификаты, firewall частично защищает) | mTLS блокирует несанкционированные подключения, rate limiting (рекомендуется), firewall правила | Перегрузка брокера, отключение устройств, недоступность системы |

### 3.5 Угрозы нарушения конфиденциальности

| Угроза | Способ реализации | Протоколы/Инфраструктура | Возможность реализации | Мероприятия по защите | Последствия |
|--------|-------------------|-------------------------|------------------------|----------------------|-------------|
| **30. Утечка конфиденциальной информации через MQTT** | Перехват MQTT-сообщений с данными о потреблении и расписании | MQTT, TLS, Wi-Fi, Контроллер | **Низкая** (TLS шифрует payload, но метаданные видны) | mTLS шифрует все сообщения, ACL ограничивает доступ к топикам | Раскрытие данных о потреблении энергии, расписании жильцов, поведении |

### 3.6 Специфические угрозы для систем электроснабжения

| Угроза | Способ реализации | Протоколы/Инфраструктура | Возможность реализации | Мероприятия по защите | Последствия |
|--------|-------------------|-------------------------|------------------------|----------------------|-------------|
| **33. Несанкционированное отключение электропитания** | Удаленное или локальное управление автоматическими выключателями | MQTT, Контроллер (ACL), Устройства (выключатели) | **Низкая** (ACL блокирует публикацию команд от устройств) | DeviceAuthorizatorPolicy блокирует публикацию в /cmd, физическая защита выключателей | Полное обесточивание дома |
| **34. Создание перегрузки электросети** | Одновременное включение мощных потребителей | MQTT, Устройства (розетки, реле), Контроллер | **Средняя** (требуется компрометация устройств или контроллера) | Программная защита от превышения мощности, мониторинг нагрузки, ACL | Повреждение оборудования, срабатывание защиты |
| **38. Несанкционированное управление электроснабжением через MQTT** | Публикация команд в MQTT топики управления | MQTT, Контроллер (ACL), DeviceAuthorizatorPolicy | **Низкая** (ACL блокирует) | DeviceAuthorizatorPolicy запрещает устройствам публиковать в /cmd топики, только контроллер может отправлять команды | Несанкционированное управление электропитанием |

---

## 4. Детализация компонентов

### 4.1 Оптический коммутатор

**Назначение:**
- Точка входа интернет-соединения в дом
- Преобразование оптического сигнала в электрический

**Угрозы:**
- Перехват оптического сигнала (требуется физический доступ)
- Физическое повреждение кабеля
- Нарушение работы канала связи

**Защита:**
- Физическая защита кабеля
- Мониторинг качества сигнала
- Резервные каналы связи (рекомендуется)

### 4.2 Роутер

**Функции:**
- NAT (Network Address Translation) - преобразование адресов
- Firewall (Stateful Packet Inspection) - фильтрация трафика
- MAC Address Filtering (Whitelist) - фильтрация по MAC-адресам
- DHCP Server - автоматическая выдача IP-адресов
- P2P связь (белый IP) - для удаленного доступа

**Конфигурация:**
- Белый IP адрес для P2P связи
- Внутренняя сеть: 192.168.1.0/24
- DHCP диапазон: 192.168.1.100-192.168.1.200

**Угрозы:**
- Взлом роутера через уязвимости
- Компрометация firewall правил
- MAC spoofing (обход MAC filtering)
- Несанкционированное проникновение

**Защита:**
- Регулярные обновления firmware
- Сложные пароли администратора
- MAC whitelist для IoT устройств
- Firewall правила (default deny)
- Отключение неиспользуемых сервисов

### 4.3 Wi-Fi контроллер

**Функции:**
- Управление Wi-Fi сетью
- Централизованная конфигурация точек доступа
- Мониторинг состояния сети

**Настройки безопасности:**
- Шифрование: WPA3
- WPS: отключен
- SSID: DICSS-IoT (для IoT устройств)
- SSID: DICSS-Main (для пользователей)

**Угрозы:**
- Взлом Wi-Fi пароля
- Перехват радиосигнала
- Глушение беспроводных каналов

**Защита:**
- WPA3 шифрование
- Сильные пароли
- Отключение WPS
- Мониторинг подозрительной активности

### 4.4 Антенны Wi-Fi

**Назначение:**
- Точки доступа для беспроводных устройств
- Распространение Wi-Fi сигнала

**Характеристики:**
- Диапазоны: 2.4 GHz и 5 GHz
- Стандарт: 802.11ax (Wi-Fi 6)

**Угрозы:**
- Глушение сигнала (jamming)
- Пассивный перехват (при слабом шифровании)

**Защита:**
- WPA3 шифрование на уровне контроллера
- Мониторинг качества сигнала

### 4.5 Контроллер умного дома

**Компоненты:**
- **MQTT Broker (Moquette)**: порт 8884 (mTLS)
- **PostgreSQL Database**: порт 5432
- **Payara 6 Application Server**: порты 9080 (HTTP), 9048 (Admin)
- **ControllerWebServer**: порт 11080 (HTTPS+mTLS, localhost only)

**IP адрес:** 192.168.1.50

**MQTT Broker конфигурация:**
- Порт 8884 (SSL/TLS): активен, слушает на 0.0.0.0:8884
- Порт 1883 (plaintext): отключен (set to 0)
- ClientAuth: REQUIRE (обязательная двусторонняя аутентификация)
- Протоколы: TLSv1.3, TLSv1.2
- Ключи: RSA 2048-bit, PKCS12 формат

**Компоненты безопасности:**
- Device Interceptor - перехват и обработка подключений
- Device Authenticator - аутентификация устройств по composite hash
- Device AuthorizatorPolicy (ACL) - политика авторизации доступа к топикам:
  - Запрет wildcard подписок для IoT устройств
  - Ограничение публикации только в разрешенные топики
  - Защита от несанкционированного управления (блокировка публикации в `/cmd`)
- Health Check Service - мониторинг состояния устройств

**MQTT топики:**
- `home/<controllerId>/devices/<deviceId>/register` - регистрация устройств
- `home/<controllerId>/devices/<deviceId>/health` - health check сообщения
- `home/<controllerId>/devices/<deviceId>/telemetry` - телеметрия
- `home/<controllerId>/devices/<deviceId>/cmd` - команды управления (только чтение для устройств)

**PostgreSQL Database:**
- IP адрес: 192.168.1.50 (локально на контроллере)
- Порт: 5432
- База данных: mqtt
- Пользователь: postgres

**Угрозы:**
- Компрометация MQTT брокера
- Компрометация базы данных
- Несанкционированный доступ к API
- DoS атаки

**Защита:**
- mTLS для MQTT
- ACL для ограничения доступа к топикам
- Firewall правила на роутере
- Регулярные обновления ПО

### 4.6 Умные устройства

**Типы устройств:**
- TEMP_SENSOR (IOT-2025-0001) - датчик температуры и влажности
- SMART_PLUG (IOT-2025-0002) - умная розетка
- ENERGY_SENSOR (IOT-2025-0003) - датчик энергопотребления
- SMART_SWITCH (IOT-2025-0004) - умный выключатель

**Характеристики:**
- Подключение: Wi-Fi (WPA3)
- Протокол: MQTT over TLS (mTLS)
- Идентификация: composite hash (SHA-256 от serial + MAC)
- Health Check: каждые 60 секунд
- Телеметрия: публикация в топики `home/+/devices/+/telemetry`

**Угрозы:**
- Взлом firmware
- Физическая манипуляция
- Клонирование устройства
- Компрометация клиентского сертификата

**Защита:**
- mTLS с клиентскими сертификатами
- Composite hash для идентификации
- Health check мониторинг
- Обнаружение клонирования

### 4.7 Смартфон

**Сценарии использования:**
- Внутри сети: подключение через Wi-Fi к локальной сети
- Снаружи (интернет): подключение через интернет к контроллеру

**Протоколы:**
- HTTPS для доступа к REST API контроллера
- Wi-Fi (WPA3) при подключении внутри сети

**Угрозы:**
- Компрометация при доступе из интернета
- Вредоносное ПО на смартфоне
- Фишинг для получения учетных данных

**Защита:**
- HTTPS для защищенного соединения
- Firewall на роутере блокирует прямой доступ из интернета
- Аутентификация в приложении (рекомендуется)

### 4.8 Пользовательский ПК

**Назначение:**
- Административный доступ к системе
- Управление устройствами через веб-интерфейс

**Протоколы:**
- HTTP для доступа к Payara REST API (локально)
- Wi-Fi или Ethernet для подключения к сети

**Угрозы:**
- Вирус на ПК
- Несанкционированное проникновение через зараженный ПК
- Компрометация учетных данных

**Защита:**
- Антивирусное ПО (рекомендуется)
- Регулярные обновления ОС
- Ограничение прав доступа
- Мониторинг подозрительной активности

---

## 5. Правила Firewall на роутере

### 5.1 Входящие правила (из Internet → LAN)

| Правило | Протокол | Порт | Направление | Действие | Описание |
|---------|----------|------|-------------|----------|----------|
| 1 | ALL | ALL | IN | DENY | Блокировать все входящие соединения по умолчанию |
| 2 | TCP/UDP | P2P порты | IN | ALLOW | Разрешить P2P трафик (белый IP) |
| 3 | TCP | 1883 | IN | DENY | MQTT plaintext - блокировать извне |
| 4 | TCP | 8884 | IN | DENY | MQTT TLS - блокировать извне |
| 5 | TCP | 5432 | IN | DENY | PostgreSQL - блокировать извне |
| 6 | TCP | 9048 | IN | DENY | Payara Admin - блокировать извне |
| 7 | TCP | 9080 | IN | DENY | Payara HTTP - блокировать извне (доступ только через VPN/P2P) |
| 8 | TCP | 11080 | IN | DENY | ControllerWebServer - блокировать извне (только localhost) |

### 5.2 Исходящие правила (из LAN → Internet)

| Правило | Протокол | Порт | Направление | Действие | Описание |
|---------|----------|------|-------------|----------|----------|
| 1 | TCP | 443 | OUT | ALLOW | HTTPS для обновлений и внешних API |
| 2 | UDP | 53 | OUT | ALLOW | DNS запросы |
| 3 | UDP | 123 | OUT | ALLOW | NTP для синхронизации времени |
| 4 | TCP | 80 | OUT | ALLOW | HTTP для обновлений (опционально) |
| 5 | ALL | ALL | OUT | DENY | Блокировать все остальное по умолчанию |

### 5.3 Внутренние правила (LAN → LAN)

| Правило | Протокол | Порт | Направление | Действие | Описание |
|---------|----------|------|-------------|----------|----------|
| 1 | TCP | 8884 | LAN→Контроллер | ALLOW | MQTT TLS - устройства могут подключаться к брокеру |
| 2 | TCP | 9080 | LAN→Контроллер | ALLOW | HTTP - доступ к REST API (локально) |
| 3 | TCP | 5432 | LAN→Контроллер | DENY | PostgreSQL - прямой доступ запрещен (только с контроллера) |
| 4 | TCP | 9048 | LAN→Контроллер | DENY | Payara Admin - прямой доступ запрещен |
| 5 | ALL | ALL | Устройство→Устройство | DENY | Блокировать прямое взаимодействие между устройствами |

---

## 6. Фильтрация по MAC-адресам

### 6.1 Процесс на роутере

**Режим работы:** Whitelist (белый список)

**Настройки:**
- Разрешить подключение только устройств с зарегистрированными MAC-адресами
- Автоматическая блокировка всех неизвестных MAC-адресов
- Логирование всех попыток подключения (успешных и неудачных)

**Процесс регистрации MAC:**
1. Администратор регистрирует устройство в системе DICSS
2. MAC-адрес устройства добавляется в whitelist роутера
3. Устройство получает доступ к Wi-Fi сети
4. Все попытки подключения с неизвестными MAC логируются

**Пример конфигурации роутера:**
```
MAC_WHITELIST_IOT = [
    "AA:BB:CC:DD:EE:01",  # TEMP_SENSOR IOT-2025-0001
    "AA:BB:CC:DD:EE:02",  # SMART_PLUG IOT-2025-0002
    "AA:BB:CC:DD:EE:03",  # ENERGY_SENSOR IOT-2025-0003
    "AA:BB:CC:DD:EE:04",  # SMART_SWITCH IOT-2025-0004
]

MAC_FILTER_MODE = "WHITELIST"
LOG_MAC_ATTEMPTS = true
BLOCK_UNKNOWN_MAC = true
```

### 6.2 В системе DICSS

**Проверка MAC-адреса при регистрации:**
- Устройство отправляет registration message с MAC-адресом
- Система валидирует формат MAC (XX:XX:XX:XX:XX:XX)
- MAC-адрес хешируется SHA-256 и сохраняется в БД
- Создается security alert типа DEVICE_REGISTRATION

**Валидация MAC в health check:**
- Каждое health check сообщение содержит MAC-адрес
- Система проверяет соответствие MAC зарегистрированному устройству
- При несоответствии создается security alert типа MAC_MISMATCH
- Устройство может быть заблокировано при повторных несоответствиях

**Обнаружение подмены устройства:**
- Если MAC-адрес изменился для устройства с тем же serial - это угроза
- Система создает security alert типа DEVICE_CLONE_DETECTED
- Критические устройства блокируются немедленно

**Хеширование MAC-адресов:**
- Все MAC-адреса хранятся в БД в виде SHA-256 хешей
- Это защищает от утечки реальных MAC-адресов при компрометации БД
- Composite hash = SHA-256(serial + MAC) для уникальной идентификации

---

## 7. Потоки данных

### 7.1 Регистрация устройства

```
┌─────────────┐
│ IoT Device  │
│ (Wi-Fi)     │
└──────┬──────┘
       │
       │ 1. Wi-Fi Connection (WPA3)
       │    MAC проверяется на роутере
       │
┌──────▼─────────────────────────────────────┐
│ Wi-Fi контроллер                           │
│ • WPA3 аутентификация                      │
└──────┬─────────────────────────────────────┘
       │
       │ 2. DHCP запрос
       │
┌──────▼─────────────────────────────────────┐
│ Роутер                                     │
│ • MAC Filter (Whitelist) - проверка MAC    │
│ • DHCP Server - выдача IP (192.168.1.101)  │
└──────┬─────────────────────────────────────┘
       │
       │ 3. MQTT Connect (mTLS)
       │    Порт 8884, ClientAuth.REQUIRE
       │
┌──────▼─────────────────────────────────────┐
│ MQTT Broker (Moquette)                     │
│ • TLS Handshake (mTLS)                     │
│ • Client Certificate Validation            │
│ • Device Interceptor                       │
└──────┬─────────────────────────────────────┘
       │
       │ 4. Registration Message
       │    Topic: home/controller1/devices/IOT-2025-0001/register
       │    Payload: {serial, mac, device_type}
       │
┌──────▼─────────────────────────────────────┐
│ Device Interceptor                         │
│ • Parse registration message               │
│ • Validate MAC format                     │
│ • Hash serial, MAC, composite             │
│ • Check for existing device               │
└──────┬─────────────────────────────────────┘
       │
       │ 5. Create Device Record
       │
┌──────▼─────────────────────────────────────┐
│ Device Registry                            │
│ • Insert into devices table                │
│ • Status: PENDING (требует одобрения)      │
│ • Store hashes (SHA-256)                   │
└──────┬─────────────────────────────────────┘
       │
       │ 6. Create Security Alert
       │
┌──────▼─────────────────────────────────────┐
│ Security Alerts                            │
│ • Alert Type: DEVICE_REGISTRATION          │
│ • Details: JSON с информацией об устройстве│
└────────────────────────────────────────────┘
```

### 7.2 Отправка телеметрии

```
┌─────────────┐
│ IoT Device  │
└──────┬──────┘
       │
       │ 1. Publish Telemetry
       │    Topic: home/controller1/devices/IOT-2025-0001/telemetry
       │    Payload: {temperature: 22.5, humidity: 60}
       │
┌──────▼─────────────────────────────────────┐
│ Wi-Fi контроллер                            │
│ • Передача через Wi-Fi (WPA3)              │
└──────┬─────────────────────────────────────┘
       │
       │ 2. MQTT Message (mTLS encrypted)
       │
┌──────▼─────────────────────────────────────┐
│ Роутер                                      │
│ • Firewall: Allow LAN→Контроллер:8884      │
└──────┬─────────────────────────────────────┘
       │
       │ 3. MQTT Message (mTLS encrypted)
       │
┌──────▼─────────────────────────────────────┐
│ MQTT Broker                                │
│ • Receive message                          │
│ • Route to subscribers                    │
└──────┬─────────────────────────────────────┘
       │
       │ 4. Device Interceptor
       │    onMessagePublished()
       │
┌──────▼─────────────────────────────────────┐
│ Telemetry Ingest Service                   │
│ • Parse topic                              │
│ • Extract device_id from topic             │
│ • Validate device exists                   │
│ • Parse JSON payload                       │
└──────┬─────────────────────────────────────┘
       │
       │ 5. Store Telemetry
       │
┌──────▼─────────────────────────────────────┐
│ PostgreSQL Database                        │
│ • Insert into telemetry table              │
│ • device_id, topic, metric_value, ts       │
└────────────────────────────────────────────┘
```

### 7.3 Административный доступ через REST API

**Сценарий 1: Смартфон внутри сети**
```
┌─────────────┐
│ Смартфон    │
│ (внутри)    │
└──────┬──────┘
       │
       │ 1. Wi-Fi подключение (WPA3)
       │
┌──────▼─────────────────────────────────────┐
│ Wi-Fi контроллер                            │
└──────┬─────────────────────────────────────┘
       │
       │ 2. DHCP запрос
       │
┌──────▼─────────────────────────────────────┐
│ Роутер                                      │
│ • MAC filtering (если включен)             │
│ • DHCP выдача IP                           │
└──────┬─────────────────────────────────────┘
       │
       │ 3. HTTP Request
       │    http://192.168.1.50:9080/api/devices
       │
┌──────▼─────────────────────────────────────┐
│ Контроллер умного дома                     │
│ • Payara 6 Application Server              │
│ • REST API Endpoint                        │
└──────┬─────────────────────────────────────┘
       │
       │ 4. Query Database
       │
┌──────▼─────────────────────────────────────┐
│ PostgreSQL Database                        │
│ • Execute query                            │
│ • Return device records                    │
└──────┬─────────────────────────────────────┘
       │
       │ 5. JSON Response
       │
┌──────▼─────────────────────────────────────┐
│ Смартфон                                    │
│ • Receive JSON with devices list           │
└────────────────────────────────────────────┘
```

**Сценарий 2: Смартфон снаружи (из интернета)**
```
┌─────────────┐
│ Смартфон    │
│ (интернет)  │
└──────┬──────┘
       │
       │ 1. HTTPS Request через интернет
       │    https://<белый_IP>:9080/api/devices
       │
┌──────▼─────────────────────────────────────┐
│ Роутер (белый IP)                          │
│ • Firewall: проверка правил                │
│ • NAT: перенаправление на контроллер       │
└──────┬─────────────────────────────────────┘
       │
       │ 2. HTTP Request (внутренний)
       │    http://192.168.1.50:9080/api/devices
       │
┌──────▼─────────────────────────────────────┐
│ Контроллер умного дома                     │
│ • Payara 6 Application Server              │
│ • REST API Endpoint                        │
└──────┬─────────────────────────────────────┘
       │
       │ 3. Query Database
       │
┌──────▼─────────────────────────────────────┐
│ PostgreSQL Database                        │
│ • Execute query                            │
│ • Return device records                    │
└──────┬─────────────────────────────────────┘
       │
       │ 4. JSON Response
       │
┌──────▼─────────────────────────────────────┐
│ Смартфон                                    │
│ • Receive JSON with devices list           │
└────────────────────────────────────────────┘
```

---

## 8. Механизмы безопасности

### 8.1 Уровень сети (Network Layer)

#### Физическая защита
- **Оптический коммутатор**: Физическая защита кабеля, мониторинг качества сигнала
- **Роутер**: Физическая защита, контроль доступа
- **Wi-Fi контроллер**: Физическая защита оборудования
- **Контроллер умного дома**: Физическая защита сервера

#### Firewall правила
- **Stateful Packet Inspection**: Отслеживание состояния соединений
- **Default Deny**: Блокировать все по умолчанию, разрешать только необходимое
- **Port-based filtering**: Блокировка неиспользуемых портов
- **Direction-based filtering**: Разные правила для входящего, исходящего и внутреннего трафика

#### MAC Address Filtering
- **Whitelist режим**: Только зарегистрированные устройства
- **Автоматическая блокировка**: Неизвестные MAC-адреса блокируются
- **Логирование**: Все попытки подключения логируются

#### Wi-Fi защита
- **WPA3 шифрование**: Современный стандарт безопасности
- **WPS отключен**: Защита от уязвимостей WPS
- **Сильные пароли**: Сложные пароли для Wi-Fi сети

### 8.2 Уровень транспорта (Transport Layer)

#### mTLS (Mutual TLS)
- **ClientAuth.REQUIRE**: Обязательная двусторонняя аутентификация
- **TLSv1.3 и TLSv1.2**: Только современные протоколы
- **RSA 2048-bit**: Стойкие криптографические ключи
- **PKCS12 формат**: Безопасное хранение ключей

#### Отключение plaintext
- **Порт 1883 отключен**: MQTT plaintext полностью отключен
- **Только порт 8884**: Единственный способ подключения - через TLS

#### Certificate Management
- **Server Certificate**: Сертификат брокера в server-keystore.p12
- **Client Certificates**: Уникальный сертификат для каждого устройства
- **Truststore**: Взаимное доверие между брокером и устройствами

### 8.3 Уровень приложения (Application Layer)

#### Device Registry
- **Хеширование идентификаторов**: SHA-256 для serial, MAC, composite hash
- **Статусы устройств**: PENDING, APPROVED, REJECTED, BLOCKED
- **Composite Hash**: SHA-256(serial + MAC) для уникальной идентификации

#### Device Authentication
- **Composite Hash проверка**: Уникальная идентификация устройства
- **Status validation**: Только APPROVED устройства могут подключаться
- **Connection tracking**: Отслеживание активных подключений

#### Access Control List (ACL) - DeviceAuthorizatorPolicy
- **Wildcard подписки**: Только ADMIN клиенты могут подписываться на "#" (все топики)
- **IoT устройства**: Ограничены только своими топиками
  - Могут публиковать только в: `/register`, `/health`, `/telemetry`
  - Могут читать только свои `/cmd` топики
  - Не могут публиковать в `/cmd` топики (защита от несанкционированного управления)
- **Controller и ADMIN клиенты**: Полный доступ ко всем топикам
- **Проверка соответствия**: Валидация соответствия clientId и deviceId в топике
- **Статус устройства**: Только APPROVED устройства могут публиковать/подписываться

#### Обнаружение угроз
- **Clone Detection**: Обнаружение дублирующих подключений
- **MAC Mismatch Detection**: Обнаружение подмены устройства
- **Time Drift Detection**: Обнаружение рассинхронизации времени
- **Offline Detection**: Обнаружение неактивных устройств (>3 минут)

#### Health Check мониторинг
- **Периодические проверки**: Каждые 60 секунд от устройств
- **Автоматическая проверка**: Система проверяет каждые 2 минуты
- **Валидация данных**: Проверка MAC, timestamp, формата JSON

#### Security Alerts
- **10 типов alerts**: Покрывают основные угрозы безопасности
- **Автоматическое создание**: Для всех событий безопасности
- **JSON детали**: Структурированная информация об инцидентах
- **REST API**: Доступ к alerts через административный интерфейс

### 8.4 Уровень данных (Data Layer)

#### База данных
- **PostgreSQL**: Надежная реляционная БД
- **Хеширование данных**: Чувствительные данные хранятся в виде хешей
- **Индексы**: Оптимизация запросов по composite_hash, status, timestamps

#### Аудит
- **Audit Logs**: Журнал всех административных действий
- **Security Alerts**: Журнал всех инцидентов безопасности
- **Connection Logs**: Логирование всех подключений устройств

### 8.5 Защита от угроз электропитания

#### Резервное питание
- **ИБП (UPS)**: Для контроллера умного дома
- **Генератор**: Для длительного отключения (рекомендуется)
- **Автоматическое переключение**: На резервное питание при отказе основного

#### Физическая защита выключателей
- **Замки и пломбы**: На автоматических выключателях
- **Ограничение доступа**: Только авторизованный персонал
- **Мониторинг состояния**: Отслеживание состояния выключателей

#### Программная защита
- **Блокировка программного управления**: Критичные выключатели не управляются через MQTT
- **Требование подтверждения**: Для опасных операций (полное отключение)
- **Двойная проверка команд**: Валидация команд управления

---

## 9. Матрица портов и протоколов

### 9.1 Сводная таблица портов

| Компонент | IP адрес | Порт | Протокол | Назначение | Доступность | Безопасность |
|-----------|----------|------|----------|------------|-------------|--------------|
| **MQTT Broker** | 192.168.1.50 | 8884 | TCP/TLS | MQTT over TLS (mTLS) | LAN only | mTLS, ClientAuth.REQUIRE |
| **MQTT Broker** | 192.168.1.50 | 1883 | TCP | MQTT plaintext | ОТКЛЮЧЕН | - |
| **PostgreSQL** | 192.168.1.50 | 5432 | TCP | Database connection | localhost only | Username/Password |
| **Payara HTTP** | 192.168.1.50 | 9080 | HTTP | REST API | LAN, Internet (через P2P) | HTTP (в production HTTPS) |
| **Payara Admin** | 192.168.1.50 | 9048 | TCP | asadmin | localhost only | - |
| **ControllerWebServer** | 127.0.0.1 | 11080 | HTTPS | Local admin interface | localhost only | HTTPS+mTLS, Basic Auth |
| **Роутер DHCP** | 192.168.1.1 | 67/68 | UDP | DHCP Server | LAN | MAC filtering |
| **Роутер P2P** | <белый_IP> | - | TCP/UDP | P2P связь | Internet | Firewall rules |

### 9.2 Матрица протоколов

| Протокол | Версия | Использование | Безопасность |
|----------|--------|---------------|--------------|
| **MQTT** | 3.1.1, 5.0 | Коммуникация с IoT устройствами | mTLS обязателен |
| **TLS** | 1.3, 1.2 | Шифрование MQTT трафика | ClientAuth.REQUIRE, RSA 2048-bit |
| **HTTPS** | 1.1, 2.0 | ControllerWebServer, доступ из интернета | mTLS, Basic Auth |
| **HTTP** | 1.1 | Payara REST API | В production должен быть HTTPS |
| **PostgreSQL** | 14+ | Database protocol | Username/Password |
| **Wi-Fi** | 802.11ax (Wi-Fi 6) | Беспроводное подключение | WPA3, WPS отключен |
| **DHCP** | - | Автоматическая выдача IP | MAC filtering |
| **NAT** | - | Преобразование адресов | Firewall rules |

### 9.3 Матрица направлений трафика

| Источник | Назначение | Порт | Протокол | Разрешение | Описание |
|----------|------------|------|----------|------------|----------|
| LAN (Устройства) | Контроллер (MQTT Broker) | 8884 | TCP/TLS | ALLOW | MQTT TLS (mTLS) |
| LAN (ПК/Смартфон) | Контроллер (Payara) | 9080 | HTTP | ALLOW | Доступ к REST API |
| Контроллер | Контроллер (PostgreSQL) | 5432 | TCP | ALLOW | Доступ к базе данных |
| Internet | Роутер (P2P) | P2P порты | TCP/UDP | ALLOW | P2P связь (белый IP) |
| Internet | Контроллер (MQTT) | 8884 | TCP/TLS | DENY | Прямой доступ запрещен |
| Internet | Контроллер (PostgreSQL) | 5432 | TCP | DENY | Прямой доступ запрещен |
| Internet | Контроллер (Payara) | 9080 | HTTP | DENY | Прямой доступ запрещен (через P2P) |
| LAN (Устройства) | LAN (Устройства) | ALL | ALL | DENY | Блокировать прямое взаимодействие |

---

## Заключение

Данная схема сетевого взаимодействия системы DICSS отражает:

1. **Реальную физическую топологию** (звездообразная сеть)
2. **Схему угроз безопасности** - где реализуются угрозы на каждом компоненте
3. **Схему информационных потоков** - как работают протоколы (DHCP, MAC, firewall, HTTPS, MQTT)
4. **Таблицу анализа угроз** - детальный анализ каждой угрозы с оценкой возможности реализации
5. **Все компоненты системы** с их функциями и угрозами
6. **Правила Firewall на роутере** для защиты от внутренних и внешних угроз
7. **Фильтрацию по MAC-адресам** на роутере
8. **Потоки данных** через реальную инфраструктуру
9. **Механизмы безопасности** на каждом уровне сети
10. **Матрицу портов и протоколов** со всеми используемыми портами

Схема предназначена для:
- Понимания где реализуются угрозы
- Понимания как работают протоколы
- Анализа возможности реализации угроз
- Настройки оборудования
- Отработки угроз безопасности
- Принятия решений о приоритетах защиты

**Методология использования:**
1. Выбрать угрозу из таблицы анализа
2. Изучить способ реализации и задействованные протоколы/инфраструктуру
3. Оценить возможность реализации с учетом защитных механизмов
4. Определить последствия при успешной реализации
5. Принять решение о необходимости дополнительных мер защиты

---

**Версия документа:** 2.0  
**Дата создания:** 2025  
**Проект:** DICSS - Проектирование прототипа системы умного дома, с учетом требований безопасности
