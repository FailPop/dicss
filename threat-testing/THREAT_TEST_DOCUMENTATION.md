# Документация тестирования угроз безопасности DICSS

## Обзор

Данный документ описывает реализованные тесты для проверки защитных механизмов системы DICSS против актуальных угроз из модели угроз ВКР.

## Структура тестов

Все тесты находятся в модуле `threat-testing` и наследуются от базового класса `ThreatTestBase`.

### Формат теста

Каждый тест содержит:
1. **Описание угрозы** - что тестируем
2. **Ожидаемое поведение системы** - как система должна реагировать
3. **Реализация теста** - код симуляции атаки
4. **Проверка результатов** - валидация защитных механизмов

## Реализованные тесты

### Тест 1: Угроза 6 - Несанкционированное подключение к MQTT-брокеру

**Файл**: `ThreatTest6_UnauthorizedMqttConnection.java`

**Описание угрозы**:
Попытка подключения к MQTT-брокеру без валидного клиентского сертификата или с невалидным сертификатом.

**Ожидаемое поведение системы**:
- Подключение отклоняется на уровне TLS handshake
- Security alert не создается (отклонение на сетевом уровне)
- Логирование попытки подключения
- Нет записей в device_connections

**Реализованные защитные механизмы**:
- mTLS с ClientAuth.REQUIRE принудительно требует клиентский сертификат
- Брокер отклоняет подключения без валидного сертификата на этапе SSL handshake

**Тестовые сценарии**:
1. Подключение с невалидным путем к keystore
2. Подключение с недоверенным сертификатом (не в truststore брокера)
3. Подключение с неверным паролем keystore

**Результаты тестирования**:
- Все попытки несанкционированного подключения отклоняются
- Нет новых записей в device_connections
- Система корректно защищена от несанкционированных подключений

---

### Тест 2: Угроза 12 - Перехват MQTT-сообщений при отсутствии TLS

**Файл**: `ThreatTest12_PlaintextPortDisabled.java`

**Описание угрозы**:
Прослушивание незашифрованного трафика между устройствами и MQTT-брокером (порт 1883) для получения управляющих команд и телеметрии.

**Ожидаемое поведение системы**:
- Порт 1883 (plaintext) отключен (не слушает соединения)
- Все подключения возможны только через TLS порт 8884
- Попытка подключения к порту 1883 завершается Connection refused

**Реализованные защитные механизмы**:
- Порт 1883 отключен в конфигурации брокера (IConfig.PORT_PROPERTY_NAME = "0")
- Только TLS порт 8884 активен
- Все сообщения передаются через зашифрованный канал

**Тестовые сценарии**:
1. Попытка подключения к plaintext порту 1883
2. Проверка что TLS порт 8884 доступен
3. Проверка что plaintext MQTT протокол отключен

**Результаты тестирования**:
- Порт 1883 закрыт и не принимает соединения
- TLS порт 8884 доступен для защищенных подключений
- Plaintext трафик полностью заблокирован

---

### Тест 3: Угроза 14 - Атака "subscribe to all" на MQTT-брокер

**Файл**: `ThreatTest14_SubscribeToAllAttack.java`

**Описание угрозы**:
Попытка подписки на топик "#" (все топики) в MQTT-брокере для получения всей информации о состоянии системы.

**Ожидаемое поведение системы**:
- DeviceAuthorizatorPolicy запрещает подписку на wildcard "#"
- Только ADMIN клиенты могут подписываться на "#"
- IOT устройства не могут подписаться на "#"
- Попытка подписки отклоняется брокером

**Реализованные защитные механизмы**:
- DeviceAuthorizatorPolicy.canRead() проверяет wildcard подписки
- Только клиенты с префиксом "ADMIN_" могут подписываться на "#"
- IOT устройства ограничены только своими топиками

**Тестовые сценарии**:
1. Попытка подписки на "#" от имени IOT устройства
2. Попытка подписки на "home/+/#" от имени IOT устройства
3. Проверка что устройство может подписаться на свой собственный топик

**Результаты тестирования**:
- Wildcard подписки отклоняются для IOT устройств
- Устройства могут подписываться только на свои топики
- Система защищена от перехвата всех сообщений

---

### Тест 4: Угроза 30 - Утечка конфиденциальной информации через MQTT

**Файл**: `ThreatTest30_MqttDataLeakage.java`

**Описание угрозы**:
Перехват MQTT-сообщений, содержащих конфиденциальные данные о потреблении энергии, расписании и поведении жильцов при отсутствии TLS.

**Ожидаемое поведение системы**:
- Все сообщения передаются через TLS (зашифрованы)
- Невозможно перехватить plaintext трафик
- Метаданные (топики) могут быть видны, но payload зашифрован
- Все соединения используют TLSv1.3 или TLSv1.2

**Реализованные защитные механизмы**:
- Принудительное использование TLS для всех подключений
- Порт 1883 (plaintext) отключен
- Все сообщения шифруются на транспортном уровне
- Использование современных протоколов TLS (v1.3, v1.2)

**Тестовые сценарии**:
1. Проверка что подключение требует TLS
2. Проверка что plaintext подключение невозможно
3. Проверка что payload зашифрован (симуляция перехватчика)
4. Проверка используемых TLS протоколов

**Результаты тестирования**:
- Все соединения используют TLS
- Payload сообщений зашифрован
- Метаданные видны (ограничение протокола MQTT)
- Используются безопасные версии TLS

---

### Тест 5: Угроза 38 - Несанкционированное управление электроснабжением через MQTT

**Файл**: `ThreatTest38_UnauthorizedControl.java`

**Описание угрозы**:
Публикация команд в MQTT топики управления реле и выключателей для несанкционированного включения/отключения питания без физического доступа.

**Ожидаемое поведение системы**:
- DeviceAuthorizatorPolicy запрещает публикацию в /cmd топики от устройств
- Только APPROVED устройства могут публиковать в свои топики (telemetry, health, register)
- PENDING/BLOCKED устройства не могут публиковать команды
- Попытка публикации команды отклоняется
- Security alert создается при попытке несанкционированной публикации

**Реализованные защитные механизмы**:
- DeviceAuthorizatorPolicy.canWrite() проверяет права на публикацию
- Устройства не могут публиковать в /cmd топики
- Только APPROVED устройства могут публиковать
- Проверка соответствия clientId и топика

**Тестовые сценарии**:
1. Попытка публикации команды от APPROVED устройства
2. Попытка публикации команды от PENDING устройства
3. Попытка публикации команды от BLOCKED устройства
4. Попытка публикации в чужой /cmd топик
5. Проверка что APPROVED устройство может публиковать телеметрию

**Результаты тестирования**:
- Команды управления отклоняются для всех устройств
- Устройства не могут публиковать в /cmd топики
- APPROVED устройства могут публиковать только телеметрию
- Система защищена от несанкционированного управления

---

## Запуск тестов

### Предварительные требования

1. PostgreSQL база данных должна быть запущена
2. Сертификаты должны быть сгенерированы (server-keystore.p12, client.p12, truststores)
3. БД должна быть инициализирована (схема создана)

### Запуск всех тестов

```bash
cd DICSS
mvn clean package -DskipTests
java -jar threat-testing/target/threat-testing-1.0-SNAPSHOT.jar
```

### Запуск отдельного теста

```bash
java -cp threat-testing/target/threat-testing-1.0-SNAPSHOT.jar io.home.threat.ThreatTest6_UnauthorizedMqttConnection
```

### Параметры запуска

- `-Dserver.keystore=path` - путь к server keystore
- `-Dserver.keystore.password=pass` - пароль server keystore
- `-Dbroker.truststore=path` - путь к broker truststore
- `-Dbroker.truststore.password=pass` - пароль broker truststore
- `-Dclient.keystore=path` - путь к client keystore
- `-Dclient.keystore.password=pass` - пароль client keystore
- `-Dclient.truststore=path` - путь к client truststore
- `-Dclient.truststore.password=pass` - пароль client truststore
- `-Dtest.db.url=jdbc:postgresql://localhost:5432/test_mqtt` - URL тестовой БД

## Интерпретация результатов

### Успешный тест (PASSED)
- Защитные механизмы сработали корректно
- Угроза была успешно заблокирована
- Система ведет себя как ожидается

### Неуспешный тест (FAILED)
- Защитные механизмы не сработали
- Угроза не была заблокирована
- Требуется доработка защитных механизмов

### Ошибка теста (ERROR)
- Тест завершился с исключением
- Возможны проблемы с окружением или конфигурацией
- Требуется проверка логов

## Рекомендации

1. Запускать тесты в изолированной тестовой среде
2. Использовать отдельную тестовую БД (test_mqtt)
3. Проверять логи после каждого теста
4. Документировать любые отклонения от ожидаемого поведения
5. Регулярно обновлять тесты при изменении системы

## Дальнейшие улучшения

1. Добавить тесты для остальных угроз из модели (фазы 2 и 3)
2. Реализовать автоматическую генерацию отчетов
3. Добавить интеграцию с CI/CD
4. Расширить покрытие тестами edge cases
5. Добавить performance тесты для DoS угроз

