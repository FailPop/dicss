# Модель угроз системы управления электроснабжением умного дома DICSS

## Содержание

1. [Обзор системы и контекст](#1-обзор-системы-и-контекст)
2. [Категоризация угроз](#2-категоризация-угроз)
3. [Деревья атак](#3-деревья-атак)
4. [Матрица рисков](#4-матрица-рисков)
5. [Меры противодействия](#5-меры-противодействия)
6. [Заключение](#6-заключение)

---

## 1. Обзор системы и контекст

### 1.1 Описание системы DICSS

**DICSS** (Distributed Internet of Things and Cyber-Physical System Security) - это система управления электроснабжением умного дома с встроенными механизмами кибербезопасности. Система обеспечивает мониторинг, управление и защиту IoT-устройств, подключенных к домашней сети электропитания.

### 1.2 Архитектура системы

Система построена по модульной архитектуре и включает следующие компоненты:

```
┌─────────────────────────────────────────────────────────────┐
│                        IoT Устройства                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ Сенсоры  │  │ Розетки  │  │  Лампы   │  │ Реле     │   │
│  │температ. │  │  умные   │  │  умные   │  │ умные    │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└──────────────────────┬──────────────────────────────────────┘
                       │ mTLS/TLS (MQTT)
                       │
┌──────────────────────▼──────────────────────────────────────┐
│              Embedded MQTT Broker (Moquette)                 │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  - Порт 8884 (mTLS) - ОБЯЗАТЕЛЬНО                      │ │
│  │  - Порт 1883 (plaintext) - ОТКЛЮЧЕН                    │ │
│  │  - ClientAuth.REQUIRE (двусторонняя аутентификация)    │ │
│  │  - Протоколы: TLSv1.3, TLSv1.2                         │ │
│  └────────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Device Interceptor                                    │ │
│  │  - Мониторинг подключений                             │ │
│  │  - Валидация устройств                                │ │
│  │  - Обнаружение клонирования                           │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
┌───────▼──────┐ ┌────▼───────┐ ┌───▼─────────────┐
│ Device       │ │ Health     │ │ Admin          │
│ Authenticator│ │ Check      │ │ Service        │
└───────┬──────┘ │ Service    │ └────┬────────────┘
        │        └────────────┘      │
        └──────────────┬─────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│              Device Registry (H2 Database)                  │
│  ┌────────────────┐  ┌─────────────────┐  ┌─────────────┐   │
│  │ devices        │  │ device_         │  │ security_   │   │ 
│  │ - serial_hash  │  │ connections     │  │ alerts      │   │ 
│  │ - mac_hash     │  │ - device_id     │  │ - alert_type│   │
│  │ - composite_   │  │ - ip_address    │  │ - details   │   │
│  │   hash (SHA-   │  │ - timestamps    │  │ - timestamps│   │
│  │   256)         │  └─────────────────┘  └─────────────┘   │
│  │ - status       │                                         │
│  │   (PENDING/    │                                         │
│  │    APPROVED/   │                                         │
│  │    BLOCKED)    │                                         │
│  └────────────────┘                                         │
└──────────────────────┬──────────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────────┐
│              Backend API (Jakarta EE / Payara 6)            │
│  ┌──────────────────┐  ┌──────────────┐  ┌───────────────┐  │
│  │ REST API         │  │ MQTT Client  │  │ Admin         │  │
│  │ /api/devices     │  │ Manager      │  │ Endpoints     │  │
│  │ /api/alerts      │  │ - Publisher  │  │ /approve      │  │
│  │ /api/connections │  │ - Subscriber │  │ /reject       │  │
│  │ /api/telemetry   │  └──────────────┘  │ /block        │  │
│  └──────────────────┘                     └──────────────┘  │
└─────────────────────────────────────────────────────────────┘
                       │
                 ┌─────▼─────┐
                 │ Админ     │
                 │ интерфейс │
                 └───────────┘
```

### 1.3 Компоненты системы

#### 1.3.1 IoT Устройства

**Типы устройств:**
- **TEMP_SENSOR** - датчик температуры и влажности
- **SMART_PLUG** - умная розетка
- **ENERGY_SENSOR** - датчик энергопотребления
- **SMART_SWITCH** - умный выключатель

**Характеристики:**
- Идентификация по серийному номеру (serial) и MAC-адресу
- Составной хеш SHA-256 от serial+MAC для уникальной идентификации
- Обязательная взаимная аутентификация (mTLS)
- Периодическая отправка health check сообщений

#### 1.3.2 MQTT Broker (Embedded Moquette)

**Безопасность:**
- **Принудительный IR** (ClientAuth.REQUIRE) - все подключения требуют сертификата клиента
- **Протоколы:** TLSv1.3, TLSv1.2 только
- **Порт 1883 (plaintext):** полностью отключен
- **Порт 8884 (SSL/TLS):** единственный активный порт
- **Ключи:** RSA 2048-bit, PKCS12 формат

**Функции:
- Device Interceptor для мониторинга подключений
- Device Authenticator для валидации устройств
- Обнаружение дублирующих подключений (cloning detection)

#### 1.3.3 Device Registry

**База данных:** H2 (embedded, файловая)

**Таблицы:**
- **devices** - регистрация устройств
  - Хешированные идентификаторы (SHA-256)
  - Статусы: PENDING, APPROVED, REJECTED, BLOCKED
  - Флаг критичности (is_critical)
  
- **device_connections** - активные подключения
  - IP-адреса устройств
  - Временные метки подключения/отключения
  
- **security_alerts** - журнал инцидентов безопасности
  - Типы алертов
  - Детали событий в JSON
  - Timestamps

#### 1.3.4 Backend API

**Технологии:** Jakarta EE 10, Payara 6

**Endpoints:**
- `/api/devices` - управление устройствами
- `/api/alerts` - просмотр security alerts
- `/api/connections` - мониторинг подключений
- `/api/telemetry` - телеметрия

**Функции:**
- Одобрение/отклонение устройств администратором
- Блокировка скомпрометированных устройств
- Мониторинг состояния системы

### 1.4 Механизмы безопасности

#### 1.4.1 Аутентификация и авторизация

**Процесс регистрации устройства:**
1. Устройство отправляет registration message на топик `device/register`
2. Система создает запись в БД со статусом PENDING
3. Генерируется security alert типа DEVICE_REGISTRATION
4. Администратор должен вручную одобрить устройство через API
5. После одобрения устройство получает статус APPROVED
6. Только APPROVED устройства могут подключаться к брокеру

**Идентификация устройств:**
- **Serial hash:** SHA-256 от серийного номера
- **MAC hash:** SHA-256 от MAC-адреса
- **Composite hash:** SHA-256(serial + MAC) - уникальный идентификатор

#### 1.4.2 Обнаружение угроз

**Система генерирует следующие типы security alerts:**

1. **DEVICE_REGISTRATION** - новое устройство зарегистрировано
2. **DEVICE_CLONE_DETECTED** - обнаружено клонирование устройства
3. **CRITICAL_DEVICE_CLONE_ATTEMPT** - попытка клонирования критического устройства
4. **DEVICE_RECONNECTION** - устройство переподключилось
5. **DEVICE_OFFLINE** - устройство неактивно >3 минут
6. **MAC_MISMATCH** - несоответствие MAC адреса
7. **TIME_DRIFT** - рассинхронизация времени >5 минут
8. **HEALTH_CHECK_ERROR** - ошибка обработки health check
9. **REGISTRATION_ERROR** - ошибка регистрации
10. **CONNECTION_ERROR** - ошибка подключения

#### 1.4.3 Health Check мониторинг

**Параметры:**
- Устройства отправляют health check каждые 60 секунд
- Система проверяет каждые 2 минуты
- Порог офлайн: 3 минуты

**Health check включает:**
- MAC адрес
- Timestamp
- Battery level
- Uptime

**Валидация:**
- Проверка формата MAC
- Проверка соответствия зарегистрированному MAC
- Проверка синхронизации времени (допуск 5 минут)
- Проверка валидности JSON

#### 1.4.4 Обнаружение клонирования

**Алгоритм:**
1. При подключении устройства система проверяет наличие активного подключения с таким же composite_hash
2. Если обнаружено дублирующее подключение:
   - Проверяется IP-адрес
   - **Если IP тот же:** считается переlysоnection - закрывается старое, разрешается новое
   - **Если IP другой:**
     - Для критических устройств: отклоняется новое, сохраняется старое
     - Для обычных устройств: блокируется устройство, отключаются оба соединения

### 1.5 Точки взаимодействия (Attack Surface)

**Внешние интерфейсы системы:**

1. **MQTT порт 8884** - единственный порт для подключения устройств (mTLS)
2. **REST API (порт 9080)** - административный интерфейс
3. **Admin API (порт 9048)** - управление Payara
4. **База данных H2** - встроенная, доступна только через приложение
5. **Файловая система** - хранение keystores, сертификатов, БД

### 1.6 Предположения безопасности (Threat Assumptions)

**Предполагается, что:**
- Физический доступ к IoT устройствам возможен (устройства находятся в доме)
- Сетевой трафик может перехватываться
- Устройства могут быть скомпрометированы (взлом firmware)
- Администратор может быть скомпрометирован
- Брокер и backend запущены на защищенном сервере с физической защитой
- Цепочка поставок сертификатов может быть уязвима

**НЕ предполагается:**
- Нарушение криптографических примитивов (SHA-256, RSA-2048, TLS)
- Физическое повреждение брокера/backend сервера

---

## 2. Категоризация угроз

Система классифицирует угрозы по следующим категориям согласно модели STRIDE:

- **S (Spoofing)** - подделка идентичности
- **T (Tampering)** - манипуляция данными
- **R (Repudiation)** - отрицание действий
- **I (Information Disclosure)** - раскрытие информации
- **D (Denial of Service)** - отказ в обслуживании
- **E (Elevation of Privilege)** - повышение привилегий

### 2.1 Атаки на канал связи (MQTT)

Категории: **T, I, D**

#### 2.1.1 Перехват трафика (Traffic Interception)

**Описание:** Злоумышленник перехватывает MQTT трафик между устройством и брокером.

**Векторы атаки:**
- Подключение к локальной сети злоумышленником
- ARP spoofing для получения трафика
- Физический доступ к кабельной сети
- Уязвимости в роутере/коммутаторе

**Возможные последствия:**
- Раскрытие телеметрии (потребление энергии, температура)
- Раскрытие команд управления
- Анализ поведения устройств
- Утечка расписания жизни жильцов

**Уязвимости:**
- Даже с mTLS, злоумышленник может видеть метаданные (топики, частоту сообщений)
- При использовании слабых шифров возможно расшифровывание

**Защита:**
-  mTLS с TLSv1.3
-  RSA 2048-bit
-  Нет защиты от анализа метаданных
-  Нет проактивного обнаружения перехвата

#### 2.1.2 Атака Man-in-the-Middle (MITM)

**Описание:** Злоумышленник встает между устройством и брокером, перехватывая и модифицируя сообщения.

**Векторы атаки:**
- Подделка ARP для перенаправления трафика
- Подделка сертификата брокера (если сертификат самоподписанный)
- Компрометация DNS
- BGP hijacking

**Возможные последствия:**
- Модификация команд устройств
- Подмена телеметрии
- Внедрение ложных команд
- Полный контроль над устройствами

**Уязвимости:**
- Если устройство не проверяет сертификат брокера должным образом
- Если truststore скомпрометирован
- Слабая проверка цепочки сертификатов

**Защита:**
-  mTLS с двусторонней аутентификацией
-  Нет certificate pinning на устройствах
-  Нет защиты от replay атак с помощью nonce

#### 2.1.3 Replay атака

**Описание:** Злоумышленник записывает легитимное сообщение и воспроизводит его позже.

**Векторы атаки:**
- Запись команды на отключение устройства
- Запись health check сообщения для маскировки офлайн устройства
- Запись registration сообщения для повторной регистрации

**Возможные последствия:**
- Отключение устройства в неподходящий момент
- Маскировка скомпрометированного устройства
- Бесконечная перерегистрация

**Уязвимости:**
- Нет timestamp validation в сообщениях
- Нет nonce/sequence numbers
- Нет криптографических меток времени (HMAC от timestamp)

**Защита:**
-  **ОТСУТСТВУЕТ** - нет защиты от replay атак

#### 2.1.4 Отказ в обслуживании (DoS) на брокер

**Описание:** Злоумышленник перегружает брокер трафиком или множественными подключениями.

**Векторы атаки:**
- **Connection flood** - множественные установления TLS соединений
- **Topic flood** - публикация большого количества сообщений
- **Oversized messages** - отправка огромных payload
- **Malformed packets** - отправка невалидных MQTT пакетов

**Возможные последствия:**
- Недоступность брокера
- Падение производительности
- Отключение легитимных устройств
- Невозможность управления системами

**Уязвимости:**
- Нет rate limiting на подключения
- Нет ограничения размера сообщений
- Нет IP-based blocking
- Нет connection timeout

**Защита:**
-  **ЧАСТИЧНО** - только mTLS защищает от несанкционированных подключений
-  **ОТСУТСТВУЕТ** - нет rate limiting, firewall rules

### 2.2 Атаки на аутентификацию

Категории: **S, E**

#### 2.2.1 Подделка устройства (Device Spoofing)

**Описание:** Злоумышленник создает поддельное устройство, выдавая себя за легитимное.

**Векторы атаки:**
- Подделка client ID (IOT{serial}{mac})
- Подделка м serial/MAC в сообщениях
- Использование украденного клиентского сертификата

**Возможные последствия:**
- Несанкционированное подключение к сети
- Получение управления над другими устройствами
- Манипуляция данными умного дома

**Уязвимости:**
- Если клиентский сертификат скомпрометирован
- Если устройство не имеет secure storage для ключей
- Слабый алгоритм генерации composite hash

**Защита:**
-  Composite hash (SHA-256 от serial+MAC)
-  mTLS с ClientAuth.REQUIRE
-  Проверка наличия устройства в registry
-  Нет Hardware Security Module (HSM) на устройствах

#### 2.2.2 Клонирование устройства (Device Cloning)

**Описание:** Злоумышленник клонирует устройство, создавая полную копию с теми же идентификаторами.

**Векторы атаки:**
- Физическая кража устройства и копирование firmware
- Экстракция ключей из компрометированного устройства
- Разработка поддельного устройства с идентичными ID

**Возможные последствия:**
- Два устройства с одним ID в сети
- Конфликты управления
- Обход системы безопасности
- Контроль злоумышленника над критическими устройствами

**Уязвимости:**
- Composite hash детерминистичен (serial+MAC одинаковые = один хеш)
- Отсутствие одноразовых параметров (nonce)
- Отсутствие encapsulated key material

**Защита:**
-  Обнаружение дублирующих подключений
-  Логика обработки клонов:
  - Отклонение для критических устройств
  - Блокировка для обычных
-  Позднее обнаружение (только при подключении)
-  Нет аппаратной защиты ключей на устройствах

#### 2.2.3 Несанкционированная регистрация устройства

**Описание:** Устройство регистрируется в системе без ведома администратора.

**Векторы атаки:**
- Использование известной уязвимости для автоматического одобрения
- Подмена адрес отправителя registration message
- Злоупотребление API для одобрения устройств

**Возможные последствия:**
- Внедрение злонамеренного устройства в сеть
- Нарушение изоляции
- Компрометация критических функций

**Уязвимости:**
- Система создает PENDING устройства при регистрации
- Если admin API скомпрометирован
- Нет дополнительной проверки при одобрении

**Защита:**
-  Статус PENDING по умолчанию
-  Требуется ручное одобрение через API
-  Security alert при регистрации
-  Нет двухфакторной аутентификации администратора
-  Нет blacklist известных вредоносных устройств

#### 2.2.4 Компрометация клиентского сертификата

**Описание:** Злоумышленник получает доступ к клиентскому сертификату устройства.

**Векторы атаки:**
- Экстракция из устройства (debugging ports, firmware dump)
- Кража keystore файла (если на устройстве)
- Social engineering для получения паролей keystore
- Side-channel атаки (timing attacks, power analysis)

**Возможные последствия:**
- Полное подделывание устройства
- Обход всех механизмов аутентификации
- Создание неограниченного количества клонов

**Уязвимости:**
- Keystore может храниться в открытом виде на устройстве
- Отсутствие защищенного хранилища (TPM, Secure Element)
- Слабая защита keystore паролем
- Нет механизма отзыва сертификатов

**Защита:**
-  mTLS с сертификатами
-  **ОТСУТСТВУЕТ** - нет аппаратной защиты ключей
-  **ОТСУТСТВУЕТ** - нет механизма revocation list

### 2.3 Атаки на устройства

Категории: **S, T, I, E**

#### 2.3.1 Взлом firmware устройства

**Описание:** Злоумышленник модифицирует или заменяет прошивку устройства.

**Векторы атаки:**
- Эксплуатация уязвимостей в bootloader
- Физический доступ к debugging ports (JTAG, UART)
- Side-channel атаки на криптографические операции
- Supply chain compromise

**Возможные последствия:**
- Внедрение backdoor в устройство
- Компрометация ключей аутентификации
- Изменение поведения устройства
- Использование устройства для атак на другие узлы

**Уязвимости:**
- Отсутствие secure boot
- Отсутствие проверки подписи firmware при обновлении
- Легкий доступ к storage ключей
- Отсутствие OTA (Over-The-Air) обновлений

**Защита:**
-  Health check мониторинг (может обнаружить изменения в поведении)
-  Позднее обнаружение (пост-фактум)
-  **ОТСУТСТВУЕТ** - нет проверки integrity firmware
-  **ОТСУТСТВУЕТ** - нет secure boot

#### 2.3.2 Физическая манипуляция устройством

**Описание:** Злоумышленник физически модифицирует устройство или подключает дополнительное оборудование.

**Векторы атаки:**
- Подключение кразрыв к устройству
- Установка пассивного разрыва (passive tap)
- Замена устройства на поддельное
- Подключение устройств отладки

**Возможные последствия:**
- Полный контроль над устройством
- Создание клона с экстракцией ключей
- Инжекция ложных данных
- Атаки на другие устройства через скомпрометированное

**Уязвимости:**
- Устройства физически доступны (находятся в доме)
- Отсутствие tamper detection (обнаружения вмешательства)
- Отсутствие secure enclosures
- Отсутствие environmental sensors

**Защита:**
-  **ЧАСТИЧНО** - MAC mismatch detection может помочь
-  **ОТСУТСТВУЕТ** - нет физической защиты
-  **ОТСУТСТВУЕТ** - нет tamper-evident seals

#### 2.3.3 Манипуляция health check данными

**Описание:** Злоумышленник модифицирует health check сообщения от устройства.

**Векторы атаки:**
- Перехват и модификация health check перед отправкой
- Создание поддельных health check от имени устройства
- Replay старых health check для маскировки офлайн состояния

**Возможные последствия:**
- Система считает устройство онлайн, когда оно офлайн
- Скрытие компрометации устройства
- Обход offline detection

**Уязвимости:**
- Health check отправляются в plain JSON (внутри TLS)
- Легко подделать, если TLS скомпрометирован
- Отсутствие криптографической подписи health check
- Нет проверки последовательности (sequence numbers)

**Защита:**
-  Transport-level шифрование (TLS)
-  Проверка MAC адреса в health check
-  Проверка timestamp
-  Но нет end-to-end подписи health check
-  Возможна replay атака

### 2.4 Атаки на брокер

Категории: **S, T, D, E**

#### 2.4.1 Компрометация брокера

**Описание:** Злоумышленник получает контроль над брокером.

**Векторы атаки:**
- Эксплуатация уязвимостей в Moquette
- Компрометация сервера, на котором работает брокер
- Компрометация сертификата брокера
- Злоупотребление привилегиями администратора

**Возможные последствия:**
- Полный контроль над всей системой
- Управление всеми устройствами
- Просмотр всей телеметрии
- Модификация правил подключения

**Уязвимости:**
- Версия Moquette 0.17 (может содержать известные уязвимости)
- Отсутствие изоляции процесса брокера (нет containerization)
- Отсутствие системного мониторинга аномалий
- Единая точка отказа

**Защита:**
-  mTLS защищает от несанкционированных подключений
-  Нет регулярных обновлений брокера
-  Нет мониторинга аномалий брокера
-  **ОТСУТСТВУЕТ** - нет высокой доступности (HA)

#### 2.4.2 Манипуляция routing таблицами

**Описание:** Злоумышленник изменяет таблицы маршрутизации MQTT топиков.

**Векторы атаки:**
- Exploitation уязвимостей в Moquette routing
- Перегрузка broker memory oversized topics
- Malformed subscription patterns

**Возможные последствия:**
- Перенаправление сообщений злоумышленнику
- Блокировка доставки сообщений устройствам
- Прослушивание приватных топиков

**Уязвимости:**
- Moquette может иметь уязвимости в wildcard subscriptions
- Нет ограничений на количество subscriptions
- Нет ACL (Access Control List) на топики

**Защита:**
-  **ОГРАНИЧЕННО** - нет ACL
-  Нет валидации subscription patterns
-  **ОТСУТСТВУЕТ** - нет ограничений на топики

#### 2.4.3 Переполнение памяти брокера

**Описание:** Злоумышленник истощает память брокера через атаку.

**Векторы атаки:**
- **Topic flooding** - создание огромного количества уникальных топиков
- **Message flooding** - отправка огромных сообщений
- **Connection exhaustion** - сохранение тысяч неактивных соединений

**Возможные последствия:**
- Падение брокера (OutOfMemory)
- Отключение всех устройств
- Невозможность восстановления без перезапуска

**Уязвимости:**
- Нет ограничений на количество топиков
- Нет ограничений на размер сообщений
- Нет timeout для неактивных соединений
- Нет очистки старых subscriptions

**Защита:**
-  **ЧАСТИЧНО** - только аутентификация ограничивает количество подключений
-  **ОТСУТСТВУЕТ** - нет rate limiting
-  **ОТСУТСТВУЕТ** - нет memory quotas

### 2.5 Атаки на базу данных

Категории: **T, I, D**

#### 2.5.1 SQL Injection

**Описание:** Злоумышленник внедряет вредоносный SQL код через параметры запроса.

**Векторы атаки:**
- Изменение device_id в API запросах
- Injection через composite_hash параметры
- Injection через alert_type фильтрацию

**Возможные последствия:**
- Обход аутентификации
- Извлечение данных о всех устройствах
- Модификация status устройств
- Удаление security alerts

**Уязвимости:**
- Использование PreparedStatement снижает риск
- Нет дополнительной валидации входных данных
- Возможно injection через сложные WHERE clauses

**Защита:**
-  Использование PreparedStatement в репозиториях
-  Параметризованные запросы
-  Нет дополнительной валидации типов
-  Возможна injection через динамические запросы

#### 2.5.2 Несанкционированный доступ к БД

**Описание:** Злоумышленник получает прямой доступ к файлу базы данных H2.

**Векторы атаки:**
- Физический доступ к серверу
- Компрометация сервера через другие уязвимости
- Кража backup копий БД
- Side-channel атаки на зашифрованную БД

**Возможные последствия:**
- Экстракция всех composite hashes
- Экстракция MAC адресов (если они не хешируются должным образом)
- Модификация статусов устройств
- Отключение security alerts

**Уязвимости:**
- База данных H2 хранится в файле на диске
- Нет шифрования базы данных
- Нет защиты файлов БД файловыми правами
- Backup могут быть не защищены

**Защита:**
-  Хеширование всех чувствительных данных (SHA-256)
-  База не зашифрована
-  Нет механизма шифрования на уровне БД
-  **ОТСУТСТВУЕТ** - нет TDE (Transparent Data Encryption)

#### 2.5.3 Отказ в обслуживании БД

**Описание:** Злоумышленник перегружает базу данных запросами.

**Векторы атаки:**
- Множественные тяжелые SELECT запросы
- Lock contention через UPDATE операций
- Database file corruption через множество записей

**Возможные последствия:**
- Недоступность регистра устройств
- Недоступность security alerts
- Долгие задержки на всех операциях
- Падение производительности всей системы

**Уязвимости:**
- Нет connection pooling с ограничениями
- Нет query timeout
- Нет индексов на всех часто используемых полях
- Нет мониторинга производительности БД

**Защита:**
-  Индексы на composite_hash, status, created_at
-  Нет connection limit
-  Нет query timeout
-  Нет мониторинга запросов

### 2.6 Атаки на административный интерфейс

Категории: **S, T, R, E**

#### 2.6.1 Неавторизованный доступ к API

**Описание:** Злоумышленник получает доступ к административным API без авторизации.

**Векторы атаки:**
- Прямой доступ к endpoints
- Проброс вложенных портов (NAT traversal)
- Злоупотребление слабыми учетными данными
- Session hijacking

**Возможные последствия:**
- Одобрение вредоносных устройств
- Блокировка легитимных устройств
- Удаление security alerts
- Модификация конфигурации

**Уязвимости:**
- Нет authentication на REST API
- Нет authorization (roles)
- Нет rate limiting
- Нет HTTPS на admin API

**Защита:**
-  **ОТСУТСТВУЕТ** - нет аутентификации
-  **ОТСУТСТВУЕТ** - нет авторизации
-  **ОТСУТСТВУЕТ** - нет HTTPS
-  Только сетевой уровень защиты

#### 2.6.2 Privlege Escalation

**Описание:** Злоумышленник получает больше привилегий чем должно быть.

**Векторы атаки:**
- Exploitation уязвимостей в Payara
- Злоупотребление недостатками проверки прав
- Переход от чтения к записи через ненадежную десериализацию

**Возможные последствия:**
- Изменение статусов устройств
- Одобрение всех устройств
- Удаление security logs
- Полный контроль над системой

**Уязвимости:**
- Нет RBAC (Role-Based Access Control)
- Все отсутствие проверок в API
- Отсутствие аудита действий администратора

**Защита:**
-  **ОТСУТСТВУЕТ** - нет системы ролей
-  Security alerts для некоторых действий (approve/reject)

#### 2.6.3 Отказ от ответственности (Repudiation)

**Описание:** Администратор отрицает выполнение критических действий.

**Векторы атаки:**
- Удаление security alerts
- Изменение логирования
- Модификация временных меток
- Использование взломанного аккаунта

**Возможные последствия:**
- Невозможность расследования инцидентов
- Сокрытие компрометации
- Отсутствие доказательств действий
- Проблемы с compliance

**Уязвимости:**
- Security alerts могут быть удалены через API
- Нет криптографически защищенных логов
- Нет off-line backup логирования
- Нет separation of duties

**Защита:**
-  Security alerts создаются автоматически
-  Но могут быть удалены вручную
-  **ОТСУТСТВУЕТ** - нет immutable logs
-  **ОТСУТСТВУЕТ** - нет external log storage

---

## 3. Деревья атак

Деревья атак представляют иерархическую структуру возможных сценариев атак на систему DICSS. Каждый узел дерева представляет цель или подцель атаки, а листья - конкретные методы атаки.

### 3.1 Дерево атаки: Компрометация устройства

Цель: Получить полный контроль над устройством в системе

```
                    ┌────────────────────────────┐
                    │ Компрометация устройства   │
                    └────────────┬───────────────┘
                                 │
         ┌───────────────────────┼───────────────────────┐
         │                       │                       │
    ┌────▼────┐           ┌──────▼──────┐        ┌──────▼────────┐
    │ Атака   │           │ Атака на    │        │ Атака на      │
    │ через   │           │ firmware    │        │ ключи         │
    │ сеть    │           └──────┬──────┘        └──────┬────────┘
    └────┬────┘                  │                       │
         │                  ┌────┴──────────┐    ┌──────┴────────┐
    ┌────┴────┐             │                │    │               │
    │         │        ┌────▼────┐    ┌─────▼────┐   │            │
    │ MITM   │        │Exploit  │    │Replace   │   │   Extract  │
    │attack  │        │bootloader│    │firmware  │   │   keys     │
    │        │        │         │    │          │   │   from     │
    │        │        └─────────┘    └──────────┘   │   storage  │
    │        │                                      │   (debug   │
    │        │                                      │    port)   │
    └────────┘                                      └────────────┘
```

**Методы атаки:**
1. **MITM attack через сеть**
   - ARP spoofing для перехвата трафика
   - Перехват и модификация команд
   - Подделка ответов от брокера

2. **Exploit bootloader**
   - Использование известных уязвимостей bootloader
   - Обход secure boot (если присутствует)
   - Загрузка вредоносного firmware

3. **Replace firmware**
   - Физический доступ к устройству
   - Использование debug портов (JTAG, UART)
   - Программирование нового firmware

4. **Extract keys from storage**
   - Dump memory через debug port
   - Side-channel атаки (power analysis)
   - Эксплуатация уязвимостей в защите ключей

### 3.2 Дерево атаки: DoS на брокер

Цель: Вывести брокер из строя или сделать его недоступным

```
                ┌──────────────────────────┐
                │ DoS на MQTT Broker       │
                └────────────┬─────────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
   ┌────▼─────┐        ┌─────▼──────┐      ┌─────▼──────┐
   │ Connection│        │Message    │      │Resource    │
   │ Flood     │        │Flood      │      │Exhaustion  │
   └────┬──────┘        └─────┬─────┘      └─────┬──────┘
        │                     │                   │
   ┌────┴────┐         ┌──────┴─────┐     ┌──────┴───────┐
   │         │         │            │     │              │
   │ Повторные│        │Создание    │     │Topic flood   │
   │TLS handshakes│    │гигантских  │     │(множество    │
   │             │    │payload      │     │уникальных    │
   │             │    │             │     │топиков)      │
   └─────────────┘    └─────────────┘     └──────────────┘
```

**Методы атаки:**
1. **Connection Flood**
   - Установление множества TLS соединений одновременно
   - Невозможность обслуживания легитимных соединений
   - Исчерпание ресурсов для TLS handshake

2. **Message Flood**
   - Отправка огромных сообщений
   - Переполнение buffer брокера
   - OutOfMemory исключения

3. **Topic Flood**
   - Создание тысяч уникальных топиков
   - Переполнение routing таблиц
   - Исчерпание памяти брокера

### 3.3 Дерево атаки: Несанкционированная регистрация устройства

Цель: Внедрить вредоносное устройство в сеть

```
              ┌───────────────────────────────────┐
              │ Незаконная регистрация устройства │
              └────────────┬──────────────────────┘
                           │
        ┌──────────────────┼────────────────────┐
        │                  │                    │
   ┌────▼────┐        ┌────▼──────┐       ┌────▼──────┐
   │ Подделка│        │Обход      │       │Exploit    │
   │client ID│        │admin      │       │admin API  │
   │         │        │approval   │       │           │
   └────┬────┘        └────┬──────┘       └────┬──────┘
        │                  │                    │
   ┌────┴────┐        ┌────┴────────┐     ┌────┴────────┐
   │         │        │             │     │             │
   │Imitate  │        │Social       │     │SQL injection│
   │known    │        │engineering  │     │             │
   │serial/MAC│       │на admin     │     │CSRF attack  │
   │         │        │             │     │             │
   └─────────┘        └─────────────┘     └─────────────┘
```

**Методы атаки:**
1. **Подделка client ID**
   - Использование известных serial/MAC пар
   - Манипуляция с composite hash
   - Создание поддельного registration message

2. **Обход admin approval**
   - Компрометация учетных данных администратора
   - Social engineering для одобрения устройства
   - Физический доступ к административной сессии

3. **Exploit admin API**
   - SQL injection в параметрах approve
   - CSRF для выполнения одобрения от имени admin
   - Злоупотребление недостатками валидации

### 3.4 Дерево атаки: Клонирование устройства

Цель: Создать копию устройства для обхода системы безопасности

```
           ┌──────────────────────────────┐
           │ Клонирование устройства      │
           └────────────┬─────────────────┘
                        │
        ┌───────────────┼────────────────┐
        │               │                │
   ┌────▼────┐    ┌─────▼─────┐    ┌────▼──────┐
   │Extract  │    │Duplicate  │    │Clone with │
   │firmware │    │certificate│    │new keys   │
   └────┬────┘    └─────┬─────┘    └────┬──────┘
        │               │               │
   ┌────┴────────┐ ┌────┴─────┐   ┌────┴─────────┐
   │             │ │          │   │              │
   │Physical     │ │Use       │   │Generate new  │
   │access to    │ │stolen    │   │certificate   │
   │device       │ │keys from │   │with same IDs │
   │             │ │comprom.  │   │              │
   │             │ │device    │   │              │
   └─────────────┘ └──────────┘   └──────────────┘
```

**Методы атаки:**
1. **Extract firmware**
   - Физический доступ к устройству
   - Использование debug ports для dump
   - Экстракция кода и ключей

2. **Duplicate certificate**
   - Кража keystore файла
   - Копирование ключей из компрометированного устройства
   - Использование одного сертификата на множестве клонов

3. **Clone with new keys**
   - Генерация нового сертификата
   - Подделка composite hash
   - Обход detection механизмов

### 3.5 Дерево атаки: Компрометация базы данных

Цель: Получить доступ к данным устройств и модифицировать их

```
         ┌────────────────────────────┐
         │ Компрометация БД           │
         └──────────┬─────────────────┘
                    │
     ┌──────────────┼──────────────┐
     │              │              │
┌────▼────┐    ┌────▼────┐    ┌───▼─────┐
│SQL      │    │File     │    │Backend  │
│Injection│    │access   │    │exploit  │
└────┬────┘    └────┬────┘    └───┬─────┘
     │              │              │
┌────┴────┐    ┌────┴─────┐   ┌───┴──────┐
│         │    │          │   │          │
│Through  │    │Physical  │   │Buffer    │
│API      │    │access to │   │overflow  │
│params   │    │DB file   │   │in        │
│         │    │          │   │repos     │
└─────────┘    └──────────┘   └──────────┘
```

---

## 4. Матрица рисков

Матрица рисков оценивает каждую угрозу по двум параметрам:
- **Вероятность (Probability):** L (Low), M (Medium), H (High)
- **Влияние (Impact):** L (Low), M (Medium), H (High), C (Critical)

Критичность риска = Вероятность × Влияние

### 4.1 Категории рисков

| Категория | Описание |
|-----------|----------|
| **VL (Very Low)** | Минимальный риск, не требует немедленных действий |
| **L (Low)** | Низкий риск, мониторинг |
| **M (Medium)** | Средний риск, требует планирования контрмер |
| **H (High)** | Высокий риск, требует немедленного внимания |
| **C (Critical)** | Критический риск, угрожает системе |

### 4.2 Матрица угроз

#### Атаки на канал связи (MQTT)

| ID | Угроза | STRIDE | Вероятность | Влияние | Критичность | Приоритет |
|----|--------|--------|-------------|---------|-------------|-----------|
| T1 | Перехват трафика | I | L | M | L | 4 |
| T2 | MITM атака | T, I | M | H | H | 2 |
| T3 | Replay атака | T | H | M | H | 1 |
| T4 | DoS на брокер | D | M | H | H | 2 |

#### Атаки на аутентификацию

| ID | Угроза | STRIDE | Вероятность | Влияние | Критичность | Приоритет |
|----|--------|--------|-------------|---------|-------------|-----------|
| A1 | Подделка устройства | S, E | M | H | H | 2 |
| A2 | Клонирование устройства | S, E | H | C | C | 1 |
| A3 | Несанкционированная регистрация | S, E | L | H | M | 3 |
| A4 | Компрометация клиентского сертификата | S, E | M | C | C | 1 |

#### Атаки на устройства

| ID | Угроза | STRIDE | Вероятность | Влияние | Критичность認вность | Приоритет |
|----|--------|--------|-------------|---------|-------------|-----------|
| D1 | Взлом firmware | T, E | H | H | C | 1 |
| D2 | Физическая манипуляция | T, I, E | M | C | C | 1 |
| D3 | Манипуляция health check | T | M | M | M | 3 |

#### Атаки на брокер

| ID | Угроза | STRIDE | Вероятность | Влияние | Критичность | Приоритет |
|----|--------|-------------|-------------|---------|-------------|-----------|
| B1 | Компрометация брокера | S, T, E | L | C | H | 2 |
| B2 | Манипуляция routing | T | L | M | L | 4 |
| B3 | Переполнение памяти | D | H | H | C | 1 |

#### Атаки на базу данных

| ID | Угроза | STRIDE | Вероятность | Влияние | Критичность | Приоритет |
|----|--------|--------|-------------|---------|-------------|-----------|
| DB1 | SQL Injection | T, I | L | H | M | 3 |
| DB2 | Несанкционированный доступ к БД | I | L | C | H | 2 |
| DB3 | DoS БД | D | M | M | M | 3 |

#### Атаки на административный интерфейс

| ID | Угроза | STRIDE | Вероятность | Влияние | Критичность | Приоритет |
|----|--------|--------|-------------|---------|-------------|-----------|
| AI1 | Неавторизованный доступ к API | S, T, E | H | C | C | 1 |
| AI2 | Privilege Escalation | E | M | C | C | 1 |
| AI3 | Repudiation | R | M | M | M | 3 |

### 4.3 Сводная таблица критических угроз

Наиболее критические угрозы (Critical или High priority):

| Угроза | Критичность | Текущая защита | Требуются меры |
|--------|-------------|----------------|----------------|
| Клонирование устройства (A2) | C | Частичная (clone detection) | Аппаратная защита ключей |
| Компрометация клиентского сертификата (A4) | C | mTLS | HSM на устройствах |
| Взлом firmware (D1) | C | Health check | Secure boot, firmware signing |
| Физическая манижноуляция (D2) | C | MAC mismatch | Tamper detection |
| Переполнение памяти брокера (B3) | C | Нет | Rate limiting, quotas |
| Неавторизованный доступ к API (AI1) | C | Нет | Аутентификация API |
| Privilege Escalation (AI2) | C | Нет | RBAC, authorization |
| Replay атака (T3) | H | Нет | Timestamps, nonces |
| MITM атака (T2) | H | Частичная (mTLS) | Certificate pinning |
| DoS на брокер (T4) | H | Частичная | Rate limiting, firewall |

---

## 5. Меры противодействия

### 5.1 Существующие контрмеры

#### 5.1.1 Механизмы защиты канала связи

**Реализовано:**
-  **mTLS с ClientAuth.REQUIRE** - обязательная двусторонняя аутентификация
-  **TLSv1.3 и TLSv1.2 только** - современные протоколы шифрования
-  **RSA 2048-bit ключи** - стойкие криптографические примитивы
-  **Порт 1883 отключен** - полностью исключен plaintext трафик

**Эффективность:** Защищает от пассивного перехвата и базовых MITM атак.

#### 5.1.2 Механизмы идентификации устройств

**Реализовано:**
-  **Composite hash (SHA-256)** - уникальная идентификация устройств
-  **Хеширование всех чувствительных данных** - serial, MAC в БД не хранятся открытым текстом
-  **Device registry** - централизованная база данных устройств

**Эффективность:** Защищает от простой подделки идентификаторов.

#### 5.1.3 Обнаружение клонирования

**Реализовано:**
-  **Duplicate connection detection** - проверка активных подключений
-  **IP-based validation** - проверка IP адресов при дубликатах
-  **Critical device protection** - особая логика для критических устройств
-  **Automatic blocking** - автоматическая блокировка сомнительных устройств

**Эффективность:** Обнаруживает клонирование при подключении, но не предотвращает.

#### 5.1.4 Health Check мониторинг

**Реализовано:**
-  **Периодические health checks** - каждые 60 секунд от устройств
-  **Offline detection** - обнаружение офлайн устройств через 3 минуты
-  **MAC validation** - проверка соответствия MAC в health check
-  **Timestamp validation** - проверка синхронизации времени (5 минут допуск)

**Эффективность:** Обнаруживает аномалии в поведении устройств.

#### 5.1.5 Security Alerts

**Реализовано:**
-  **Автоматическое создание alerts** - для всех событий безопасности
-  **10 типов alerts** - покрывают основные угрозы
-  **JSON детали** - структурированная информация об инцидентах
-  **REST API для просмотра** - интеграция с админ интерфейсом

**Эффективность:** Обеспечивает аудит и расследование инцидентов.

### 5.2 Рекомендуемые улучшения

#### 5.2.1 Высокоприоритетные улучшения (Critical)

**1. Защита от Replay атак**
- **Проблема:** Отсутствие защиты от повторного использования старых сообщений
- **Решение:** 
  - Добавить timestamp в каждое сообщение
  - Генерировать nonce для каждого сообщения
  - Валидировать последовательность (sequence numbers)
  - Добавить HMAC-SHA256 подпись с timestamp
- **Реализация:** Модификация MQTT сообщений, добавление заголовков с защитными метками

**2. Аутентификация и авторизация API**
- **Проблема:** REST API полностью открыт
- **Решение:**
  - JWT-based authentication
  - RBAC (Role-Based Access Control)
  - HTTPS для всех endpoints
  - Rate limiting per user
- **Реализация:** Jakarta EE Security, добавление filters, создание системы ролей

**3. Rate limiting и DoS защита**
- **Проблема:** Нет защиты от перегрузки брокера
- **Решение:**
  - Connection rate limiting per IP
 IP whitelisting для устройств
  - Maximum connection limits
  - Message size limits (max 256 KB)
  - Topic count quotas
  - Circuit breaker для перегрузок
- **Реализация:** Фильтры Moquette, firewall rules, конфигурация брокера

**4. Аппаратная защита ключей на устройствах**
- **Проблема:** Ключи хранятся в программном виде
- **Решение:**
  - TPM (Trusted Platform Module)
  - Secure Element
  - Hardware Security Module (HSM) для критических устройств
- **Реализация:** Требования к hardware для устройств, интеграция с TPM API

#### 5.2.2 Среднеприоритетные улучшения (High)

**5. Certificate pinning**
- **Проблема:** Возможна MITM атака при компрометации CA
- **Решение:** 
  - Фиксированные сертификаты брокера на устройствах
  - Проверка certificate chain
  - Возможность обновления pinned certificates через OTA
- **Реализация:** Модификация MQTT клиента, добавление pin list

**6. Secure boot и firmware signing**
- **Проблема:** Возможен взлом firmware
- **Решение:**
  - Цифровая подпись firmware (ECDSA или ГОСТ 34.10-2018)
  - Verified boot на устройствах
  - OTA updates с проверкой подписи
- **Реализация:** Требования к bootloader устройств, PKI для firmware

**7. Tamper detection**
- **Проблема:** Физическое вмешательство не обнаруживается
- **Решение:**
  - Environmental sensors (открытие корпуса)
  - Tamper-evident seals
  - Anti-tamper circuitry
  - Логирование физических сигналов
- **Реализация:** Требования к hardware, добавление sensors в устройства

**8. Database encryption**
- **Проблема:** База данных не зашифрована
- **Решение:**
  - Transparent Data Encryption (TDE) для H2
  - Encrypted backups
  - Key management system
- **Реализация:** поведение database encryption H2, backup encryption

**9. Immutable logging**
- **Проблема:** Security alerts можно удалить
- **Решение:**
  - Append-only log storage
  - External log repository (Syslog, ELK)
  - Cryptographic hash chain для logs
  - Off-site backups
- **Реализация:** Writable-off структура БД, integration с external logging

#### 5.2.3 Низкоприоритетные улучшения (Medium)

**10. Anomaly detection**
- **Решение:**
  - Machine learning для detection аномалий в поведении
  - Статистический анализ трафика
  - Обнаружение неизвестных паттернов
- **Реализация:** Analytics module, ML models

**11. Network segmentation**
- **Решение:**
  - VLAN разделение устройств по типам
  - Micro-segmentation для критических устройств
  - Firewall rules между сегментами
- **Реализация:** Network configuration, SDN

**12. Backup и recovery**
- **Решение:**
  - Автоматические backups БД
  - Disaster recovery план
  - Hot standby для критических компонентов
- **Реализация:** Backup scripts, HA setup

**13. Security updates**
- **Решение:**
  - Автоматические обновления брокера
  - OTA updates для устройств
  - Patch management system
- **Реализация:** Update mechanism, testing procedures

### 5.3 Архитектурные улучшения

**1. Распределенная архитектура**
- **Проблема:** Единая точка отказа (брокер)
- **Решение:** Кластер брокеров, sharding по устройствам
- **Бенефиты:** Высокая доступность, масштабируемость

**2. Использование Zero Trust модели**
- **Принципы:**
  - Не доверяй никому по умолчанию
  - Проверяй каждый запрос
  - Минимальные привилегии
- **Реализация:** Context-based access control, continuous monitoring

**3. Blockchain для audit logs**
- **Решение:** Distributed ledger для security alerts
- **Бенефиты:** Immutability, distributed trust, transparency

### 5.4 Compliance и стандарты

**Соответствие стандартам:**
- **ГОСТ 34.10-2018** - цифровая подпись для firmware (рекомендуется)
- **ГОСТ Р 71866-2024** - требования к АСУЗ умного дома
- **IEC 62351** - защита каналов связи в энергосистемах
- **NIST SP 800-82** - безопасность OT систем

**Интеграция:**
- Использование ГОСТ-криптографии где требуется
- Соответствие требованиям ФСТЭК
- Audit logging для compliance

---

## 6. Заключение

### 6.1 Резюме угроз

Система DICSS реализует базовые механизмы безопасности для защиты IoT-устройств умного дома:

**Сильные стороны:**
-  Принудительный IR в mTLS защищает от большинства сетевых атак
-  Composite hash обеспечивает уникальную идентификацию устройств
-  Обнаружение клонирования работает в runtime
-  Health check мониторинг обеспечивает видимость состояния
-  Security alerts обеспечивают аудит

**Критические уязвимости:**
-  Отсутствие защиты от replay атак
-  Полностью открытый административный API
-  Нет rate limiting против DoS
-  Отсутствие аппаратной защиты ключей
-  Нет protection от физических атак

### 6.2 Приоритеты противодействия

**Критические (необходимо реализовать немедленно):**
1. Защита от replay атак (timestamps + nonces)
2. Аутентификация API
3. Rate limiting и DoS защита
4. Аппаратная защита ключей (для production)

**Важные (реализовать в ближайшее время):**
5. Certificate pinning
6. Secure boot и firmware signing
7. Database encryption
8. Immutable logging

**Желательные (план на будущее):**
9. Anomaly detection
10. Network segmentation
11. Zero Trust архитектура
12. Blockchain для audit

### 6.3 Рекомендации по безопасности

**Для разработки:**
- Проводить threat modeling на каждом этапе
- Регулярный security code review
- Penetration testing перед выпуском
- Security audits внешними экспертами

**Для эксплуатации:**
- Регулярные обновления всех компонентов
- Мониторинг security alerts
- Audit log analysis
- Incident response plan

**Для устройств:**
- Требовать TPM/Secure Element
- Обеспечить secure boot
- Regular firmware updates
- Physical security measures

### 6.4 Итоговая оценка

Система DICSS представляет собой **солидную основу** для безопасного управления IoT-устройствами в умном доме. Реализованные механизмы обеспечивают базовую защиту от большинства векторов атак через сеть.

Однако для production использования критически важными являются:
- Защита от replay атак
- Аутентификация административного API
- Rate limiting против DoS

С этими улучшениями система достигнет уровня **production-ready security** для большинства сценариев использования.

---

**Версия документа:** 1.0  
**Дата:** 2025  
**Автор:** Система анализа угроз DICSS  
**Статус:** Финальная версия

